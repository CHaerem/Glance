name: Build and Deploy

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'esp32-client/gooddisplay-clean/**'
      - 'docker-compose.yml'
      - '.github/workflows/test-and-build.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit to detect changes

    - name: Check for ESP32 changes
      id: esp32_changes
      run: |
        # Check if ESP32 client files changed in this push
        if git diff --name-only HEAD~1 HEAD | grep -q "^esp32-client/"; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ESP32 firmware files changed - will build"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No ESP32 firmware changes - skipping build"
        fi

    # Build ESP32 firmware for OTA (only if ESP32 files changed)
    - name: Set up Python
      if: steps.esp32_changes.outputs.changed == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      if: steps.esp32_changes.outputs.changed == 'true'
      run: pip install platformio

    - name: Build ESP32 firmware
      if: steps.esp32_changes.outputs.changed == 'true'
      working-directory: esp32-client/gooddisplay-clean
      env:
        FIRMWARE_VERSION: ${{ github.sha }}
        WIFI_SSID: ${{ secrets.WIFI_SSID }}
        WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}
        DEVICE_ID: "esp32-ota"
      run: |
        # Build the firmware
        pio run --environment esp32s3

        # Copy firmware to server data directory for Docker build
        mkdir -p ../../server/data
        cp .pio/build/esp32s3/firmware.bin ../../server/data/firmware.bin

        # Show firmware info
        ls -la ../../server/data/firmware.bin
        echo "Firmware version: $FIRMWARE_VERSION"

    # Start Tailscale early (runs in parallel with build)
    - name: Join tailnet
      uses: tailscale/github-action@v3
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
        tags: tag:ci
        args: --ssh

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/glance-server
        tags: |
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix=sha-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./server
        file: ./server/Dockerfile
        platforms: linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        # Use registry cache (faster for arm64 cross-builds)
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/glance-server:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/glance-server:buildcache,mode=max
        build-args: |
          IMAGE_VERSION=${{ github.sha }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}

    - name: Deploy to serverpi
      env:
        SHORT_SHA: ${{ github.sha }}
        OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        BUILD_DATE: ${{ github.event.head_commit.timestamp }}
      run: |
        SHORT_SHA=${SHORT_SHA:0:7}
        # Copy docker-compose.yml and deploy in one SSH session
        scp -o StrictHostKeyChecking=no docker-compose.yml chris@100.108.19.115:~/glance/docker-compose.yml
        tailscale ssh chris@100.108.19.115 "cd ~/glance && IMAGE_VERSION=sha-${SHORT_SHA} BUILD_DATE='${BUILD_DATE}' OPENAI_API_KEY='${OPENAI_KEY}' docker compose pull --quiet && IMAGE_VERSION=sha-${SHORT_SHA} BUILD_DATE='${BUILD_DATE}' OPENAI_API_KEY='${OPENAI_KEY}' docker compose up -d && docker image prune -af --filter 'until=1h' && sudo systemctl restart kiosk.service"
