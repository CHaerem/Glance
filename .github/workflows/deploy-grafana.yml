name: Deploy Grafana Dashboard and Alerts

on:
  push:
    branches: [main]
    paths:
      - 'server/grafana-dashboard.json'
      - 'server/grafana-alert-rules.yaml'
      - '.github/workflows/deploy-grafana.yml'
  workflow_dispatch:

jobs:
  deploy-grafana:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy dashboard to Grafana Cloud
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_SA_TOKEN: ${{ secrets.GRAFANA_SA_TOKEN }}
        run: |
          # Check if secrets are configured
          if [ -z "$GRAFANA_URL" ] || [ -z "$GRAFANA_SA_TOKEN" ]; then
            echo "::warning::Grafana secrets not configured. Skipping deployment."
            echo "To enable: Add GRAFANA_URL and GRAFANA_SA_TOKEN to repository secrets."
            exit 0
          fi

          echo "Deploying dashboard to Grafana Cloud..."

          # Deploy dashboard using Grafana API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${GRAFANA_URL}/api/dashboards/db" \
            -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @server/grafana-dashboard.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Dashboard deployed successfully!"
            echo "$BODY" | jq -r '.url // "Dashboard URL not returned"'
          else
            echo "::error::Failed to deploy dashboard (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Deploy alert rules to Grafana Cloud
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_SA_TOKEN: ${{ secrets.GRAFANA_SA_TOKEN }}
        run: |
          # Check if secrets are configured
          if [ -z "$GRAFANA_URL" ] || [ -z "$GRAFANA_SA_TOKEN" ]; then
            exit 0  # Already warned in previous step
          fi

          # Check if alert rules file exists
          if [ ! -f "server/grafana-alert-rules.yaml" ]; then
            echo "No alert rules file found, skipping."
            exit 0
          fi

          echo "Deploying alert rules to Grafana Cloud..."

          # Convert YAML to JSON for API (requires yq)
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            echo "Installing yq..."
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi

          # Extract and deploy each rule group
          GROUPS=$(yq -o=json '.groups' server/grafana-alert-rules.yaml)

          for GROUP_NAME in $(echo "$GROUPS" | jq -r '.[].name'); do
            echo "Deploying rule group: $GROUP_NAME"

            GROUP_JSON=$(echo "$GROUPS" | jq --arg name "$GROUP_NAME" '.[] | select(.name == $name)')
            FOLDER=$(echo "$GROUP_JSON" | jq -r '.folder // "Glance"')

            # Create folder if it doesn't exist
            curl -s -X POST \
              "${GRAFANA_URL}/api/folders" \
              -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"title\": \"$FOLDER\"}" > /dev/null 2>&1 || true

            # Get folder UID
            FOLDER_UID=$(curl -s \
              "${GRAFANA_URL}/api/folders" \
              -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
              | jq -r --arg title "$FOLDER" '.[] | select(.title == $title) | .uid')

            if [ -z "$FOLDER_UID" ]; then
              echo "::warning::Could not find/create folder $FOLDER"
              continue
            fi

            # Deploy each rule in the group
            RULES=$(echo "$GROUP_JSON" | jq -c '.rules[]')

            echo "$RULES" | while read -r RULE; do
              RULE_UID=$(echo "$RULE" | jq -r '.uid')
              RULE_TITLE=$(echo "$RULE" | jq -r '.title')

              # Build the rule payload for Grafana API
              RULE_PAYLOAD=$(echo "$RULE" | jq --arg folder "$FOLDER_UID" --arg group "$GROUP_NAME" '{
                uid: .uid,
                title: .title,
                condition: .condition,
                data: .data,
                noDataState: .noDataState,
                execErrState: .execErrState,
                for: .for,
                annotations: .annotations,
                labels: .labels,
                folderUID: $folder,
                ruleGroup: $group,
                orgId: 1
              }')

              # Try to update existing rule, or create new one
              RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
                "${GRAFANA_URL}/api/v1/provisioning/alert-rules/${RULE_UID}" \
                -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
                -H "Content-Type: application/json" \
                -H "X-Disable-Provenance: true" \
                -d "$RULE_PAYLOAD")

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

              if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
                echo "  ✓ $RULE_TITLE"
              elif [ "$HTTP_CODE" -eq 404 ]; then
                # Rule doesn't exist, create it
                RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                  "${GRAFANA_URL}/api/v1/provisioning/alert-rules" \
                  -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
                  -H "Content-Type: application/json" \
                  -H "X-Disable-Provenance: true" \
                  -d "$RULE_PAYLOAD")

                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                if [ "$HTTP_CODE" -eq 201 ]; then
                  echo "  ✓ $RULE_TITLE (created)"
                else
                  echo "  ✗ $RULE_TITLE (HTTP $HTTP_CODE)"
                fi
              else
                echo "  ✗ $RULE_TITLE (HTTP $HTTP_CODE)"
              fi
            done
          done

          echo "Alert rules deployment complete!"
