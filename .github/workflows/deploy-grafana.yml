name: Deploy Grafana Dashboard and Alerts

on:
  push:
    branches: [main]
    paths:
      - 'server/grafana-dashboard.json'
      - 'server/grafana-alert-rules.yaml'
      - '.github/workflows/deploy-grafana.yml'
  workflow_dispatch:

jobs:
  deploy-grafana:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy dashboard to Grafana Cloud
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_SA_TOKEN: ${{ secrets.GRAFANA_SA_TOKEN }}
        run: |
          # Check if secrets are configured
          if [ -z "$GRAFANA_URL" ] || [ -z "$GRAFANA_SA_TOKEN" ]; then
            echo "::warning::Grafana secrets not configured. Skipping deployment."
            echo "To enable: Add GRAFANA_URL and GRAFANA_SA_TOKEN to repository secrets."
            exit 0
          fi

          echo "Deploying dashboard to Grafana Cloud..."

          # Deploy dashboard using Grafana API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${GRAFANA_URL}/api/dashboards/db" \
            -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @server/grafana-dashboard.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Dashboard deployed successfully!"
            echo "$BODY" | jq -r '.url // "Dashboard URL not returned"'
          else
            echo "::error::Failed to deploy dashboard (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Deploy alert rules to Grafana Cloud
        continue-on-error: true  # Don't fail the whole workflow if alert rules fail
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_SA_TOKEN: ${{ secrets.GRAFANA_SA_TOKEN }}
        run: |
          set -x  # Debug mode

          # Check if secrets are configured
          if [ -z "$GRAFANA_URL" ] || [ -z "$GRAFANA_SA_TOKEN" ]; then
            echo "Secrets not configured, skipping alert rules."
            exit 0
          fi

          # Check if alert rules file exists
          if [ ! -f "server/grafana-alert-rules.yaml" ]; then
            echo "No alert rules file found, skipping."
            exit 0
          fi

          echo "Deploying alert rules to Grafana Cloud..."

          # Install yq
          echo "Installing yq..."
          wget -qO /tmp/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
          chmod +x /tmp/yq

          # Test yq works
          /tmp/yq --version

          # Create or get Glance folder for alerts
          echo "Getting/creating Glance folder..."

          # First try to get existing folder
          FOLDER_UID=$(curl -s \
            "${GRAFANA_URL}/api/folders" \
            -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
            | jq -r '.[] | select(.title == "Glance") | .uid' | head -1)

          if [ -z "$FOLDER_UID" ] || [ "$FOLDER_UID" = "null" ]; then
            # Create new folder
            echo "Creating new Glance folder..."
            FOLDER_RESPONSE=$(curl -s -X POST \
              "${GRAFANA_URL}/api/folders" \
              -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{"title": "Glance Alerts"}')
            echo "Folder response: $FOLDER_RESPONSE"
            FOLDER_UID=$(echo "$FOLDER_RESPONSE" | jq -r '.uid')
          fi

          echo "Using folder UID: $FOLDER_UID"

          if [ -z "$FOLDER_UID" ] || [ "$FOLDER_UID" = "null" ]; then
            echo "::warning::Could not find/create folder. Alert rules not deployed."
            echo "You can import alert rules manually from server/grafana-alert-rules.yaml"
            exit 0
          fi

          # Convert YAML to JSON and deploy each rule
          echo "Processing alert rules..."
          RULES=$(/tmp/yq -o=json '.groups[].rules[]' server/grafana-alert-rules.yaml)

          echo "$RULES" | jq -c '.' | while read -r RULE; do
            RULE_UID=$(echo "$RULE" | jq -r '.uid')
            RULE_TITLE=$(echo "$RULE" | jq -r '.title')
            echo "Deploying: $RULE_TITLE"

            # Build API payload
            PAYLOAD=$(echo "$RULE" | jq --arg folder "$FOLDER_UID" '{
              uid: .uid,
              title: .title,
              condition: .condition,
              data: .data,
              noDataState: .noDataState,
              execErrState: .execErrState,
              for: .for,
              annotations: .annotations,
              labels: .labels,
              folderUID: $folder,
              ruleGroup: "Glance Alerts",
              orgId: 1
            }')

            # Try PUT first (update), then POST (create)
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
              "${GRAFANA_URL}/api/v1/provisioning/alert-rules/${RULE_UID}" \
              -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
              -H "Content-Type: application/json" \
              -H "X-Disable-Provenance: true" \
              -d "$PAYLOAD")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "  ✓ Updated: $RULE_TITLE"
            elif [ "$HTTP_CODE" = "404" ]; then
              # Create new rule
              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "${GRAFANA_URL}/api/v1/provisioning/alert-rules" \
                -H "Authorization: Bearer ${GRAFANA_SA_TOKEN}" \
                -H "Content-Type: application/json" \
                -H "X-Disable-Provenance: true" \
                -d "$PAYLOAD")

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
                echo "  ✓ Created: $RULE_TITLE"
              else
                echo "  ✗ Failed: $RULE_TITLE (HTTP $HTTP_CODE)"
                echo "    Response: $(echo "$RESPONSE" | head -n -1)"
              fi
            else
              echo "  ✗ Failed: $RULE_TITLE (HTTP $HTTP_CODE)"
              echo "    Response: $BODY"
            fi
          done

          echo "Alert rules deployment complete!"
