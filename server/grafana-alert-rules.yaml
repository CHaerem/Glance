# Grafana Alert Rules for Glance E-Ink Display Monitor
# Provisioning file for Grafana 9+ Unified Alerting
#
# To use: Place in Grafana provisioning directory:
#   /etc/grafana/provisioning/alerting/alert-rules.yaml
#
# Or import via Grafana UI: Alerting > Alert rules > Import

apiVersion: 1

groups:
  - orgId: 1
    name: Glance - Device Alerts
    folder: Glance
    interval: 1m
    rules:
      # Battery Critical - Voltage below 3.3V
      - uid: glance-battery-voltage-critical
        title: Battery Voltage Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_volts
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 3.3
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery voltage critically low on {{ $labels.device_id }}"
          description: "Battery voltage is {{ $values.B }}V, below critical threshold of 3.3V. Device may shut down soon."
        labels:
          severity: critical
          device: "{{ $labels.device_id }}"

      # Battery Critical - Percentage below 15%
      - uid: glance-battery-percent-critical
        title: Battery Percentage Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_percent
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 15
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery critically low on {{ $labels.device_id }}"
          description: "Battery is at {{ $values.B }}%, below critical threshold of 15%. Charge the device soon."
        labels:
          severity: critical
          device: "{{ $labels.device_id }}"

      # Battery Low Warning - Voltage below 3.5V
      - uid: glance-battery-voltage-low
        title: Battery Voltage Low
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_volts
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 3.5
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery voltage low on {{ $labels.device_id }}"
          description: "Battery voltage is {{ $values.B }}V, below warning threshold of 3.5V. Consider charging soon."
        labels:
          severity: warning
          device: "{{ $labels.device_id }}"

