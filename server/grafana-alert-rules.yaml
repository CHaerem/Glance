# Grafana Alert Rules for Glance E-Ink Display Monitor
# Provisioning file for Grafana 9+ Unified Alerting
#
# To use: Place in Grafana provisioning directory:
#   /etc/grafana/provisioning/alerting/alert-rules.yaml
#
# Or import via Grafana UI: Alerting > Alert rules > Import

apiVersion: 1

groups:
  - orgId: 1
    name: Glance - Device Alerts
    folder: Glance
    interval: 1m
    rules:
      # Battery Critical - Voltage below 3.3V
      - uid: glance-battery-voltage-critical
        title: Battery Voltage Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_volts
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 3.3
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery voltage critically low on {{ $labels.device_id }}"
          description: "Battery voltage is {{ $values.B }}V, below critical threshold of 3.3V. Device may shut down soon."
        labels:
          severity: critical
          device: "{{ $labels.device_id }}"

      # Battery Critical - Percentage below 15%
      - uid: glance-battery-percent-critical
        title: Battery Percentage Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_percent
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 15
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery critically low on {{ $labels.device_id }}"
          description: "Battery is at {{ $values.B }}%, below critical threshold of 15%. Charge the device soon."
        labels:
          severity: critical
          device: "{{ $labels.device_id }}"

      # Device Offline - No check-in for 10+ minutes
      - uid: glance-device-offline
        title: Device Offline
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_online
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: Alerting
        execErrState: Error
        for: 10m
        annotations:
          summary: "Device {{ $labels.device_id }} is offline"
          description: "Device has not checked in for over 10 minutes. Check WiFi connectivity or battery status."
        labels:
          severity: warning
          device: "{{ $labels.device_id }}"

      # Brownout Detected - Counter increased
      - uid: glance-brownout-detected
        title: Brownout Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 86400  # 24 hours
              to: 0
            datasourceUid: prometheus
            model:
              expr: increase(glance_device_brownout_count_total[1h])
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 86400
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          summary: "Brownout detected on {{ $labels.device_id }}"
          description: "Device experienced a brownout (power dip). This may indicate battery issues or high current draw during display refresh."
        labels:
          severity: warning
          device: "{{ $labels.device_id }}"

      # Battery Low Warning - Voltage below 3.5V
      - uid: glance-battery-voltage-low
        title: Battery Voltage Low
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_battery_volts
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 3.5
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Battery voltage low on {{ $labels.device_id }}"
          description: "Battery voltage is {{ $values.B }}V, below warning threshold of 3.5V. Consider charging soon."
        labels:
          severity: warning
          device: "{{ $labels.device_id }}"

  - orgId: 1
    name: Glance - Server Alerts
    folder: Glance
    interval: 1m
    rules:
      # Server High Memory Usage
      - uid: glance-server-memory-high
        title: Server Memory High
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_server_memory_heap_used_bytes / 1024 / 1024
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 400  # 400MB heap usage
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Glance server memory usage high"
          description: "Server heap usage is {{ $values.B }}MB, above 400MB threshold. Check for memory leaks."
        labels:
          severity: warning

      # Server Down - No uptime metric
      - uid: glance-server-down
        title: Server Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="glance"}
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: Alerting
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "Glance server is down"
          description: "Prometheus cannot scrape Glance server metrics. Check if the server container is running."
        labels:
          severity: critical

      # WiFi Signal Weak
      - uid: glance-wifi-signal-weak
        title: WiFi Signal Weak
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: glance_device_signal_rssi_dbm
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - -75  # dBm, weak signal
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          summary: "WiFi signal weak on {{ $labels.device_id }}"
          description: "WiFi signal is {{ $values.B }} dBm. Consider moving device closer to router or adding a WiFi extender."
        labels:
          severity: info
          device: "{{ $labels.device_id }}"
