<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        a { color: #666; text-decoration: none; }
        a:hover { color: #1a1a1a; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .back-link {
            font-size: 0.85rem;
        }

        /* Device Status Bar */
        .status-bar {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .status-item {
            text-align: center;
            min-width: 80px;
        }

        .status-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .status-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-dot.online { background: #10b981; }
        .status-dot.offline { background: #9ca3af; }

        /* Section */
        .section {
            margin-bottom: 16px;
        }

        .section-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Settings Card */
        .card {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .form-row {
            margin-bottom: 16px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .form-hint {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
        }

        .preset-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: #fff;
            border: 1px solid #e5e5e5;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .preset-btn:hover {
            border-color: #1a1a1a;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary:hover {
            background: #333;
        }

        .success-msg {
            color: #10b981;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 12px;
            display: none;
        }

        .success-msg.show {
            display: block;
        }

        /* Collapsible */
        .collapsible {
            background: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #ebebeb;
        }

        .collapsible-title {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .collapsible-icon {
            font-size: 0.75rem;
            color: #999;
            transition: transform 0.2s;
        }

        .collapsible.open .collapsible-icon {
            transform: rotate(90deg);
        }

        .collapsible-content {
            display: none;
            padding: 0 16px 16px;
        }

        .collapsible.open .collapsible-content {
            display: block;
        }

        /* Logs */
        .log-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.7rem;
            color: #e5e5e5;
            padding: 4px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #666;
            margin-right: 8px;
        }

        .log-error {
            color: #ef4444;
        }

        .log-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .log-btn {
            background: #fff;
            border: 1px solid #e5e5e5;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .log-btn:hover {
            border-color: #1a1a1a;
        }

        /* Footer */
        .footer {
            text-align: center;
            font-size: 0.7rem;
            color: #999;
            padding: 20px 0;
            border-top: 1px solid #f0f0f0;
            margin-top: 24px;
        }

        .footer a {
            color: #666;
        }

        /* Night sleep time inputs */
        .time-range {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .time-range select {
            flex: 1;
            padding: 8px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Orientation buttons */
        .orientation-btns {
            display: flex;
            gap: 8px;
        }

        .orientation-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
        }

        .orientation-btn.active {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        /* Next Wake Card - Prominent */
        .next-wake-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
        }

        .next-wake-time {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .next-wake-countdown {
            font-size: 0.9rem;
            color: #999;
        }

        .next-wake-card.soon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .next-wake-card.soon .next-wake-countdown {
            color: rgba(255,255,255,0.8);
        }

        .next-wake-card.overdue {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Mobile */
        @media (max-width: 480px) {
            body { padding: 16px; }
            .status-bar { gap: 12px; padding: 12px; }
            .status-item { min-width: 70px; }
            .status-value { font-size: 0.9rem; }
            .next-wake-time { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Admin</h1>
        <a href="/" class="back-link">Back to gallery</a>
    </div>

    <!-- Next Wake - Prominent -->
    <div class="next-wake-card" id="nextWakeCard">
        <div class="next-wake-time" id="nextWakeTime">--:--</div>
        <div class="next-wake-countdown" id="nextWakeCountdown">--</div>
    </div>

    <!-- Device Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-value" id="deviceState">
                <span class="status-dot offline"></span>--
            </div>
            <div class="status-label">Status</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="batteryDisplay">--</div>
            <div class="status-label">Battery</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="signalDisplay">--</div>
            <div class="status-label">Signal</div>
        </div>
    </div>

    <!-- Settings -->
    <div class="section">
        <div class="section-header">Settings</div>
        <div class="card">
            <div class="form-row">
                <label class="form-label">Update Interval</label>
                <input type="number" id="sleepDuration" class="form-input" min="5" max="1440" placeholder="15">
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setPreset(5)">5m</button>
                    <button class="preset-btn" onclick="setPreset(15)">15m</button>
                    <button class="preset-btn" onclick="setPreset(30)">30m</button>
                    <button class="preset-btn" onclick="setPreset(60)">1h</button>
                    <button class="preset-btn" onclick="setPreset(360)">6h</button>
                    <button class="preset-btn" onclick="setPreset(1440)">24h</button>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Display Orientation</label>
                <div class="orientation-btns">
                    <button class="orientation-btn" id="btnPortrait" onclick="setOrientation('portrait')">Portrait</button>
                    <button class="orientation-btn" id="btnLandscape" onclick="setOrientation('landscape')">Landscape</button>
                </div>
            </div>

            <div class="form-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="nightSleepEnabled" onchange="toggleNightSleep()">
                    Night Sleep
                </label>
                <div id="nightSleepOptions" style="display: none;">
                    <div class="time-range">
                        <select id="nightStart">
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23" selected>23:00</option>
                            <option value="0">00:00</option>
                        </select>
                        <span>to</span>
                        <select id="nightEnd">
                            <option value="5" selected>05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-row" id="devModeRow">
                <label class="checkbox-label">
                    <input type="checkbox" id="devMode" onchange="toggleDevMode()">
                    Development Mode
                </label>
                <div id="devServerOptions" style="display: none; margin-top: 8px;">
                    <input type="text" id="devServerHost" class="form-input" placeholder="192.168.1.100:3000">
                </div>
            </div>

            <div class="form-row">
                <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
                <div class="success-msg" id="successMsg">Settings saved!</div>
            </div>
        </div>
    </div>

    <!-- Logs (collapsible) -->
    <div class="collapsible" id="logsSection">
        <div class="collapsible-header" onclick="toggleSection('logsSection')">
            <span class="collapsible-title">Logs</span>
            <span class="collapsible-icon">&#9654;</span>
        </div>
        <div class="collapsible-content">
            <div class="log-controls">
                <button class="log-btn" onclick="loadLogs()">Refresh</button>
                <button class="log-btn" id="autoRefreshBtn" onclick="toggleAutoRefresh()">Auto: Off</button>
            </div>
            <div class="log-container" id="logOutput">Loading...</div>
        </div>
    </div>

    <!-- Diagnostics (collapsible) -->
    <div class="collapsible" id="diagSection">
        <div class="collapsible-header" onclick="toggleSection('diagSection')">
            <span class="collapsible-title">Diagnostics</span>
            <span class="collapsible-icon">&#9654;</span>
        </div>
        <div class="collapsible-content">
            <div class="log-controls">
                <button class="log-btn" onclick="loadDiagnostics()">Refresh</button>
            </div>
            <div id="diagOutput" style="font-size: 0.8rem;">Loading...</div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <span id="serverInfo">Loading...</span>
    </div>

    <script>
        let autoRefreshInterval = null;
        let selectedOrientation = 'portrait';

        // Toggle collapsible sections
        function toggleSection(id) {
            document.getElementById(id).classList.toggle('open');
        }

        // Load settings
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const s = await res.json();

                document.getElementById('sleepDuration').value = Math.round(s.defaultSleepDuration / 1000000 / 60);
                document.getElementById('devMode').checked = s.devMode || false;
                document.getElementById('devServerHost').value = s.devServerHost || '';
                document.getElementById('nightSleepEnabled').checked = s.nightSleepEnabled || false;
                document.getElementById('nightStart').value = s.nightSleepStartHour || 23;
                document.getElementById('nightEnd').value = s.nightSleepEndHour || 5;

                setOrientation(s.defaultOrientation || 'portrait');
                toggleNightSleep();
                toggleDevMode();

                // Hide dev mode on dev server
                if (!window.location.hostname.includes('serverpi')) {
                    document.getElementById('devModeRow').style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const minutes = parseInt(document.getElementById('sleepDuration').value);
                if (!minutes || minutes < 5 || minutes > 1440) {
                    alert('Enter a value between 5 and 1440 minutes');
                    return;
                }

                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        defaultSleepDuration: minutes * 60 * 1000000,
                        defaultOrientation: selectedOrientation,
                        devMode: document.getElementById('devMode').checked,
                        devServerHost: document.getElementById('devServerHost').value.trim(),
                        nightSleepEnabled: document.getElementById('nightSleepEnabled').checked,
                        nightSleepStartHour: parseInt(document.getElementById('nightStart').value),
                        nightSleepEndHour: parseInt(document.getElementById('nightEnd').value)
                    })
                });

                const msg = document.getElementById('successMsg');
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            } catch (e) {
                alert('Failed to save settings');
            }
        }

        function setPreset(min) {
            document.getElementById('sleepDuration').value = min;
        }

        function setOrientation(o) {
            selectedOrientation = o;
            document.getElementById('btnPortrait').classList.toggle('active', o === 'portrait');
            document.getElementById('btnLandscape').classList.toggle('active', o === 'landscape');
        }

        function toggleNightSleep() {
            const enabled = document.getElementById('nightSleepEnabled').checked;
            document.getElementById('nightSleepOptions').style.display = enabled ? 'block' : 'none';
        }

        function toggleDevMode() {
            const enabled = document.getElementById('devMode').checked;
            document.getElementById('devServerOptions').style.display = enabled ? 'block' : 'none';
        }

        // Load device status
        async function loadDeviceStatus() {
            try {
                const res = await fetch('/api/esp32-status');
                const s = await res.json();

                // Status
                const stateEl = document.getElementById('deviceState');
                const isOnline = s.state === 'online';
                stateEl.innerHTML = `<span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'Online' : 'Offline'}`;

                // Battery
                if (s.batteryVoltage) {
                    let bat = `${s.batteryVoltage}V`;
                    if (s.batteryPercent != null) bat += ` (${s.batteryPercent}%)`;
                    if (s.isCharging) bat += ' âš¡';
                    document.getElementById('batteryDisplay').textContent = bat;
                } else {
                    document.getElementById('batteryDisplay').textContent = '--';
                }

                // Signal
                document.getElementById('signalDisplay').textContent = s.signalStrength ? `${s.signalStrength}dBm` : '--';

                // Next wake - store for live countdown
                if (s.lastSeen && s.sleepDuration) {
                    window.nextWakeTimestamp = s.lastSeen + (s.sleepDuration / 1000);
                    updateNextWakeDisplay();
                } else {
                    window.nextWakeTimestamp = null;
                    document.getElementById('nextWakeTime').textContent = '--:--';
                    document.getElementById('nextWakeCountdown').textContent = 'No data';
                    document.getElementById('nextWakeCard').className = 'next-wake-card';
                }
            } catch (e) {
                console.error('Failed to load status:', e);
            }
        }

        // Load logs
        async function loadLogs() {
            try {
                const res = await fetch('/api/device-logs-combined?limit=50');
                const data = await res.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    document.getElementById('logOutput').innerHTML = '<div style="color:#666">No logs</div>';
                    return;
                }

                let html = '';
                logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                    const isError = log.level === 'ERROR' || log.message.toLowerCase().includes('error');
                    html += `<div class="log-entry ${isError ? 'log-error' : ''}">
                        <span class="log-time">${time}</span>${log.message}
                    </div>`;
                });
                document.getElementById('logOutput').innerHTML = html;
            } catch (e) {
                document.getElementById('logOutput').innerHTML = '<div style="color:#ef4444">Error loading logs</div>';
            }
        }

        // Load diagnostics
        async function loadDiagnostics() {
            try {
                const res = await fetch('/api/wake-cycle-diagnostics');
                const data = await res.json();

                if (!data.latestCycle) {
                    document.getElementById('diagOutput').innerHTML = 'No wake cycle data yet';
                    return;
                }

                const c = data.latestCycle;
                const dur = Math.round(c.duration / 1000);
                const errors = c.errors.length;

                let html = `<div style="margin-bottom:12px">
                    <strong>Last cycle:</strong> ${dur}s duration, ${c.events.length} events, ${errors} errors
                </div>`;

                if (data.recentCycles && data.recentCycles.length > 1) {
                    html += '<div style="color:#666; font-size:0.75rem">';
                    html += `Recent: ${data.recentCycles.length} cycles tracked`;
                    html += '</div>';
                }

                document.getElementById('diagOutput').innerHTML = html;
            } catch (e) {
                document.getElementById('diagOutput').innerHTML = 'Error loading diagnostics';
            }
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const res = await fetch('/api/system-info');
                const info = await res.json();
                const hours = Math.floor(info.uptime / 3600);
                const mins = Math.floor((info.uptime % 3600) / 60);
                document.getElementById('serverInfo').innerHTML =
                    `${info.version || 'local'} &middot; Node ${info.nodeVersion} &middot; Up ${hours}h ${mins}m`;
            } catch (e) {
                document.getElementById('serverInfo').textContent = 'Server info unavailable';
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'Auto: Off';
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadLogs();
                    loadDeviceStatus();
                }, 3000);
                btn.textContent = 'Auto: On';
            }
        }

        // Live countdown for next wake
        function updateNextWakeDisplay() {
            if (!window.nextWakeTimestamp) return;

            const now = Date.now();
            const diffMs = window.nextWakeTimestamp - now;
            const card = document.getElementById('nextWakeCard');
            const timeEl = document.getElementById('nextWakeTime');
            const countdownEl = document.getElementById('nextWakeCountdown');

            // Show the actual wake time
            const wakeDate = new Date(window.nextWakeTimestamp);
            timeEl.textContent = wakeDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            if (diffMs > 0) {
                // Countdown
                const totalSecs = Math.floor(diffMs / 1000);
                const mins = Math.floor(totalSecs / 60);
                const secs = totalSecs % 60;

                if (mins >= 60) {
                    const hrs = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    countdownEl.textContent = `in ${hrs}h ${remainMins}m`;
                } else if (mins > 0) {
                    countdownEl.textContent = `in ${mins}m ${secs}s`;
                } else {
                    countdownEl.textContent = `in ${secs}s`;
                }

                // Add "soon" class if less than 2 minutes
                card.className = mins < 2 ? 'next-wake-card soon' : 'next-wake-card';
            } else {
                // Overdue
                const overdueMins = Math.floor(Math.abs(diffMs) / 60000);
                countdownEl.textContent = overdueMins < 1 ? 'waking now...' : `${overdueMins}m overdue`;
                card.className = 'next-wake-card overdue';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadDeviceStatus();
            loadSystemInfo();
            loadLogs();
            loadDiagnostics();
            setInterval(loadDeviceStatus, 5000);
            setInterval(updateNextWakeDisplay, 1000); // Live countdown every second
        });
    </script>
</body>
</html>
