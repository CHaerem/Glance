<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        a { color: #666; text-decoration: none; }
        a:hover { color: #1a1a1a; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .back-link {
            font-size: 0.85rem;
        }

        /* Next Wake Card - Prominent */
        .next-wake-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
        }

        .next-wake-label {
            font-size: 0.75rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .next-wake-time {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .next-wake-countdown {
            font-size: 0.9rem;
            color: #999;
        }

        .next-wake-card.soon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .next-wake-card.soon .next-wake-countdown,
        .next-wake-card.soon .next-wake-label {
            color: rgba(255,255,255,0.8);
        }

        .next-wake-card.overdue {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .next-wake-card.offline {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .next-wake-card.offline .next-wake-countdown,
        .next-wake-card.offline .next-wake-label {
            color: rgba(255,255,255,0.7);
        }

        /* OTA Update Banner */
        .ota-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ota-banner.hidden {
            display: none;
        }

        .ota-banner-content {
            flex: 1;
        }

        .ota-banner-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .ota-banner-message {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }

        .ota-banner-icon {
            font-size: 1.5rem;
            margin-right: 12px;
        }

        /* Device Status Bar */
        .status-bar {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .status-item {
            text-align: center;
            min-width: 80px;
        }

        .status-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .status-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-dot.online { background: #10b981; }
        .status-dot.offline { background: #9ca3af; }

        .stale-warning {
            font-size: 0.7rem;
            color: #f59e0b;
            margin-top: 2px;
        }

        /* Section */
        .section {
            margin-bottom: 20px;
        }

        .section-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Card */
        .card {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .form-row {
            margin-bottom: 16px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .form-hint {
            font-size: 0.7rem;
            color: #999;
            margin-top: 4px;
        }

        .preset-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: #fff;
            border: 1px solid #e5e5e5;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .preset-btn:hover {
            border-color: #1a1a1a;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary:hover {
            background: #333;
        }

        .success-msg {
            color: #10b981;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 12px;
            display: none;
        }

        .success-msg.show {
            display: block;
        }

        /* Night sleep time inputs */
        .time-range {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .time-range select {
            flex: 1;
            padding: 8px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Orientation buttons */
        .orientation-btns {
            display: flex;
            gap: 8px;
        }

        .orientation-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
        }

        .orientation-btn.active {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        /* Logs */
        .log-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.7rem;
            color: #e5e5e5;
            padding: 4px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #666;
            margin-right: 8px;
        }

        .log-error {
            color: #ef4444;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn-small {
            background: #fff;
            border: 1px solid #e5e5e5;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .btn-small:hover {
            border-color: #1a1a1a;
        }

        /* Footer */
        .footer {
            text-align: center;
            font-size: 0.7rem;
            color: #999;
            padding: 20px 0;
            border-top: 1px solid #f0f0f0;
            margin-top: 24px;
        }

        /* Battery Graph */
        .battery-graph {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .battery-graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .battery-graph-title {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .battery-graph-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .battery-graph-value.charging {
            color: #10b981;
        }

        .battery-graph-value.low {
            color: #f59e0b;
        }

        .battery-graph-value.critical {
            color: #ef4444;
        }

        .graph-container {
            height: 80px;
            position: relative;
            display: flex;
            gap: 6px;
        }

        .graph-y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.6rem;
            color: #999;
            min-width: 28px;
            text-align: right;
            padding: 2px 0;
        }

        .graph-svg-container {
            flex: 1;
            height: 100%;
        }

        .graph-svg {
            width: 100%;
            height: 100%;
        }

        .graph-line {
            fill: none;
            stroke: #1a1a1a;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .graph-area {
            fill: rgba(26, 26, 26, 0.1);
        }

        .graph-charging {
            stroke: #10b981;
        }

        .signal-line {
            stroke: #6366f1;
        }

        .signal-area {
            fill: rgba(99, 102, 241, 0.1);
        }

        .signal-good {
            color: #10b981;
        }

        .signal-fair {
            color: #f59e0b;
        }

        .signal-weak {
            color: #ef4444;
        }

        .graph-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #999;
            margin-top: 4px;
            margin-left: 34px; /* Align with graph (y-axis width + gap) */
        }

        /* Device Stats */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px 16px;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
        }

        .stat-value {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #999;
            display: block;
            margin-top: 4px;
        }

        .stat-error {
            color: #f59e0b;
        }

        .stat-warning {
            color: #f59e0b;
        }

        /* Brownout History */
        .brownout-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .brownout-stat {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #fef3c7;
            border-radius: 8px;
        }

        .brownout-stat-value {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #d97706;
        }

        .brownout-stat-label {
            display: block;
            font-size: 0.7rem;
            color: #92400e;
            margin-top: 2px;
        }

        .brownout-table-container {
            max-height: 200px;
            overflow-y: auto;
        }

        .brownout-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .brownout-table th {
            text-align: left;
            padding: 6px 8px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            font-weight: 500;
            color: #6b7280;
        }

        .brownout-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        .brownout-table tr:hover td {
            background: #fef3c7;
        }

        .voltage-critical { color: #dc2626; font-weight: 600; }
        .voltage-low { color: #f59e0b; font-weight: 600; }
        .voltage-ok { color: #10b981; }

        /* Battery Consumption */
        .consumption-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .consumption-card {
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid #e5e5e5;
        }

        .consumption-card.highlight {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .consumption-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .consumption-value.high {
            color: #dc2626;
        }

        .consumption-value.medium {
            color: #f59e0b;
        }

        .consumption-value.low {
            color: #10b981;
        }

        .consumption-label {
            font-size: 0.7rem;
            color: #6b7280;
            line-height: 1.3;
        }

        .consumption-count {
            font-size: 0.65rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Firmware Analysis */
        .firmware-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .firmware-table th {
            text-align: left;
            padding: 8px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #6b7280;
        }

        .firmware-table td {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        .firmware-table tr:hover td {
            background: #f9fafb;
        }

        .firmware-version {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.7rem;
        }

        .firmware-current {
            background: #dcfce7;
        }

        .efficiency-better {
            color: #10b981;
            font-weight: 600;
        }

        .efficiency-worse {
            color: #dc2626;
            font-weight: 600;
        }

        .session-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .session-date {
            font-weight: 500;
            font-size: 0.85rem;
        }

        .session-duration {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .session-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .session-stat {
            font-size: 0.75rem;
        }

        .session-stat-value {
            font-weight: 600;
        }

        .session-firmware {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.65rem;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Mobile */
        @media (max-width: 480px) {
            body { padding: 16px; }
            .status-bar { gap: 12px; padding: 12px; }
            .status-item { min-width: 70px; }
            .status-value { font-size: 0.9rem; }
            .next-wake-time { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Admin</h1>
        <a href="/" class="back-link">Back to gallery</a>
    </div>

    <!-- Next Wake - Prominent -->
    <div class="next-wake-card" id="nextWakeCard">
        <div class="next-wake-label">Next Wake</div>
        <div class="next-wake-time" id="nextWakeTime">--:--</div>
        <div class="next-wake-countdown" id="nextWakeCountdown">--</div>
    </div>

    <!-- OTA Update Banner -->
    <div class="ota-banner hidden" id="otaBanner">
        <span class="ota-banner-icon">ðŸ“¡</span>
        <div class="ota-banner-content">
            <div class="ota-banner-title" id="otaBannerTitle">OTA Update Available</div>
            <div class="ota-banner-message" id="otaBannerMessage">--</div>
        </div>
    </div>

    <!-- Device Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-value" id="deviceState">
                <span class="status-dot offline"></span>--
            </div>
            <div class="status-label">Status</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="batteryDisplay">--</div>
            <div class="status-label">Battery</div>
            <div class="stale-warning" id="batteryStale"></div>
        </div>
        <div class="status-item">
            <div class="status-value" id="signalDisplay">--</div>
            <div class="status-label">Signal</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="firmwareDisplay">--</div>
            <div class="status-label">Client</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="serverVersionDisplay">--</div>
            <div class="status-label">Server</div>
        </div>
    </div>

    <!-- Battery Graph -->
    <div class="battery-graph" id="batteryGraphSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">Battery History</span>
            <span class="battery-graph-value" id="batteryGraphValue">--</span>
        </div>
        <div class="graph-container">
            <div class="graph-y-axis">
                <span id="graphVoltMax">--</span>
                <span id="graphVoltMin">--</span>
            </div>
            <div class="graph-svg-container">
                <svg class="graph-svg" id="batteryGraphSvg" viewBox="0 0 300 80" preserveAspectRatio="none">
                    <path class="graph-area" id="graphArea"></path>
                    <path class="graph-line" id="graphLine"></path>
                </svg>
            </div>
        </div>
        <div class="graph-labels">
            <span id="graphTimeStart">--</span>
            <span id="graphTimeEnd">Now</span>
        </div>
    </div>

    <!-- Signal Graph -->
    <div class="battery-graph" id="signalGraphSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">Signal History</span>
            <span class="battery-graph-value" id="signalGraphValue">--</span>
        </div>
        <div class="graph-container">
            <div class="graph-y-axis">
                <span id="signalGraphMax">--</span>
                <span id="signalGraphMin">--</span>
            </div>
            <div class="graph-svg-container">
                <svg class="graph-svg" id="signalGraphSvg" viewBox="0 0 300 80" preserveAspectRatio="none">
                    <path class="graph-area signal-area" id="signalArea"></path>
                    <path class="graph-line signal-line" id="signalLine"></path>
                </svg>
            </div>
        </div>
        <div class="graph-labels">
            <span id="signalTimeStart">--</span>
            <span id="signalTimeEnd">Now</span>
        </div>
    </div>

    <!-- Brownout History -->
    <div class="battery-graph" id="brownoutSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">âš¡ Brownout History</span>
            <span class="battery-graph-value stat-warning" id="brownoutHeaderCount">0</span>
        </div>
        <div class="brownout-summary" id="brownoutSummary">
            <div class="brownout-stat">
                <span class="brownout-stat-value" id="brownoutAvgVoltage">--</span>
                <span class="brownout-stat-label">Avg voltage at brownout</span>
            </div>
            <div class="brownout-stat">
                <span class="brownout-stat-value" id="brownoutLastTime">--</span>
                <span class="brownout-stat-label">Last brownout</span>
            </div>
        </div>
        <div class="brownout-table-container">
            <table class="brownout-table" id="brownoutTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Voltage</th>
                        <th>Battery %</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="brownoutTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Battery Consumption Per Operation -->
    <div class="battery-graph" id="consumptionSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">ðŸ”‹ Battery Consumption by Operation</span>
            <span class="battery-graph-value" id="consumptionTotalDrop">--</span>
        </div>
        <div class="consumption-grid">
            <div class="consumption-card highlight">
                <div class="consumption-value" id="consumptionDisplayDrop">--</div>
                <div class="consumption-label">mV per display update</div>
                <div class="consumption-count" id="consumptionDisplayCount">-- updates</div>
            </div>
            <div class="consumption-card">
                <div class="consumption-value" id="consumptionWakeDrop">--</div>
                <div class="consumption-label">mV per normal wake</div>
                <div class="consumption-count" id="consumptionWakeCount">-- wakes</div>
            </div>
            <div class="consumption-card">
                <div class="consumption-value" id="consumptionOtaDrop">--</div>
                <div class="consumption-label">mV per OTA update</div>
                <div class="consumption-count" id="consumptionOtaCount">-- updates</div>
            </div>
        </div>
    </div>

    <!-- Firmware Version Comparison -->
    <div class="battery-graph" id="firmwareSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">ðŸ“Š Firmware Efficiency Comparison</span>
            <span class="battery-graph-value" id="firmwareSampleCount">-- samples</span>
        </div>
        <div class="brownout-table-container">
            <table class="firmware-table" id="firmwareTable">
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Display mV</th>
                        <th>Wake mV</th>
                        <th>Samples</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody id="firmwareTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Session History -->
    <div class="battery-graph" id="sessionSection" style="display: none;">
        <div class="battery-graph-header">
            <span class="battery-graph-title">ðŸ“ˆ Charge Cycle History</span>
            <span class="battery-graph-value" id="sessionCount">-- cycles</span>
        </div>
        <div id="sessionList" style="max-height: 300px; overflow-y: auto;">
        </div>
    </div>

    <!-- Device Stats -->
    <div class="stats-row" id="statsSection" style="display: none;">
        <div class="stat-item">
            <span class="stat-value" id="statWakes">--</span>
            <span class="stat-label">Wakes</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="statUpdates">--</span>
            <span class="stat-label">Display updates</span>
        </div>
        <div class="stat-item" id="statBrownoutItem" style="display: none;">
            <span class="stat-value stat-warning" id="statBrownout">--</span>
            <span class="stat-label">Brownouts</span>
        </div>
        <div class="stat-item" id="statOtaItem" style="display: none;">
            <span class="stat-value" id="statOta">--</span>
            <span class="stat-label">Last OTA</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="statImage">--</span>
            <span class="stat-label">Current image</span>
        </div>
        <div class="stat-item" id="statErrorItem" style="display: none;">
            <span class="stat-value stat-error" id="statError">--</span>
            <span class="stat-label">Last issue</span>
        </div>
    </div>

    <!-- Settings -->
    <div class="section">
        <div class="section-header">Settings</div>
        <div class="card">
            <div class="form-row">
                <label class="form-label">Update Interval</label>
                <input type="number" id="sleepDuration" class="form-input" min="5" max="1440" placeholder="15">
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setPreset(5)">5m</button>
                    <button class="preset-btn" onclick="setPreset(15)">15m</button>
                    <button class="preset-btn" onclick="setPreset(30)">30m</button>
                    <button class="preset-btn" onclick="setPreset(60)">1h</button>
                    <button class="preset-btn" onclick="setPreset(360)">6h</button>
                    <button class="preset-btn" onclick="setPreset(1440)">24h</button>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Display Orientation</label>
                <div class="orientation-btns">
                    <button class="orientation-btn" id="btnPortrait" onclick="setOrientation('portrait')">Portrait</button>
                    <button class="orientation-btn" id="btnLandscape" onclick="setOrientation('landscape')">Landscape</button>
                </div>
            </div>

            <div class="form-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="nightSleepEnabled" onchange="toggleNightSleep()">
                    Night Sleep
                </label>
                <div id="nightSleepOptions" style="display: none;">
                    <div class="time-range">
                        <select id="nightStart">
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23" selected>23:00</option>
                            <option value="0">00:00</option>
                        </select>
                        <span>to</span>
                        <select id="nightEnd">
                            <option value="5" selected>05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-row" id="devModeRow">
                <label class="checkbox-label">
                    <input type="checkbox" id="devMode" onchange="toggleDevMode()">
                    Development Mode
                </label>
                <div id="devServerOptions" style="display: none; margin-top: 8px;">
                    <input type="text" id="devServerHost" class="form-input" placeholder="192.168.1.100:3000">
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Low Battery Webhook</label>
                <input type="text" id="notificationWebhook" class="form-input" placeholder="https://webhook.example.com/notify">
                <div class="form-hint">Sends POST when battery drops below 30% or 15%</div>
            </div>

            <div class="form-row">
                <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
                <div class="success-msg" id="successMsg">Settings saved!</div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div class="section">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Recent Logs</span>
                <button class="btn-small" onclick="loadLogs()">Refresh</button>
            </div>
            <div class="log-container" id="logOutput">Loading...</div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <span id="serverInfo">Loading...</span>
    </div>

    <script>
        let selectedOrientation = 'portrait';

        // Load settings
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const s = await res.json();

                document.getElementById('sleepDuration').value = Math.round(s.defaultSleepDuration / 1000000 / 60);
                document.getElementById('devMode').checked = s.devMode || false;
                document.getElementById('devServerHost').value = s.devServerHost || '';
                document.getElementById('nightSleepEnabled').checked = s.nightSleepEnabled || false;
                document.getElementById('nightStart').value = s.nightSleepStartHour || 23;
                document.getElementById('nightEnd').value = s.nightSleepEndHour || 5;
                document.getElementById('notificationWebhook').value = s.notificationWebhook || '';

                setOrientation(s.defaultOrientation || 'portrait');
                toggleNightSleep();
                toggleDevMode();

                // Hide dev mode on dev server
                if (!window.location.hostname.includes('serverpi')) {
                    document.getElementById('devModeRow').style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const minutes = parseInt(document.getElementById('sleepDuration').value);
                if (!minutes || minutes < 5 || minutes > 1440) {
                    alert('Enter a value between 5 and 1440 minutes');
                    return;
                }

                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        defaultSleepDuration: minutes * 60 * 1000000,
                        defaultOrientation: selectedOrientation,
                        devMode: document.getElementById('devMode').checked,
                        devServerHost: document.getElementById('devServerHost').value.trim(),
                        nightSleepEnabled: document.getElementById('nightSleepEnabled').checked,
                        nightSleepStartHour: parseInt(document.getElementById('nightStart').value),
                        nightSleepEndHour: parseInt(document.getElementById('nightEnd').value),
                        notificationWebhook: document.getElementById('notificationWebhook').value.trim()
                    })
                });

                const msg = document.getElementById('successMsg');
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            } catch (e) {
                alert('Failed to save settings');
            }
        }

        function setPreset(min) {
            document.getElementById('sleepDuration').value = min;
        }

        function setOrientation(o) {
            selectedOrientation = o;
            document.getElementById('btnPortrait').classList.toggle('active', o === 'portrait');
            document.getElementById('btnLandscape').classList.toggle('active', o === 'landscape');
        }

        function toggleNightSleep() {
            const enabled = document.getElementById('nightSleepEnabled').checked;
            document.getElementById('nightSleepOptions').style.display = enabled ? 'block' : 'none';
        }

        function toggleDevMode() {
            const enabled = document.getElementById('devMode').checked;
            document.getElementById('devServerOptions').style.display = enabled ? 'block' : 'none';
        }

        // Format time ago
        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Format version display with GitHub link and timestamp
        function formatVersionDisplay(element, version, buildDate) {
            if (!version || version === 'unknown' || version === 'local') {
                element.textContent = version || '--';
                element.title = '';
                return;
            }

            // Extract SHA (handle both "sha-abc1234" and full SHA formats)
            let sha = version;
            if (version.startsWith('sha-')) {
                sha = version.substring(4);
            }

            // If it's a semantic version (1.2.3), just display it
            if (/^\d+\.\d+\.\d+/.test(version)) {
                element.textContent = version;
                element.title = buildDate ? formatTimestamp(buildDate) : '';
                return;
            }

            // For git SHA, create clickable link
            const shortSha = sha.substring(0, 7);
            const githubUrl = `https://github.com/CHaerem/Glance/commit/${sha}`;

            // Create clickable link
            element.innerHTML = `<a href="${githubUrl}" target="_blank" style="color: inherit; text-decoration: none;">${shortSha}</a>`;

            // Add timestamp to title
            if (buildDate) {
                element.title = formatTimestamp(buildDate);
            } else {
                element.title = `Full SHA: ${sha}`;
            }
        }

        // Format timestamp in Oslo timezone
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', {
                    timeZone: 'Europe/Oslo',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (e) {
                return isoString;
            }
        }

        // Fetch and display server version
        async function updateServerVersion() {
            try {
                const res = await fetch('/api/system-info');
                if (!res.ok) return;

                const data = await res.json();
                const serverEl = document.getElementById('serverVersionDisplay');
                formatVersionDisplay(serverEl, data.version, data.buildDate);
            } catch (error) {
                console.error('Failed to fetch server version:', error);
            }
        }

        // Check for OTA updates
        async function checkOTAUpdate(currentVersion) {
            const banner = document.getElementById('otaBanner');
            const title = document.getElementById('otaBannerTitle');
            const message = document.getElementById('otaBannerMessage');

            // If no current version, can't compare
            if (!currentVersion) {
                banner.classList.add('hidden');
                return;
            }

            try {
                // Fetch available firmware version from server
                const res = await fetch('/api/firmware/version');

                // If no firmware available on server (404), hide banner
                if (!res.ok) {
                    banner.classList.add('hidden');
                    return;
                }

                const firmware = await res.json();
                const availableVersion = firmware.version;

                // Compare versions - if different, show OTA banner
                if (availableVersion && availableVersion !== currentVersion) {
                    // Format versions for display (shorten git SHAs)
                    const currentShort = currentVersion.match(/^\d+\.\d+\.\d+/) ? currentVersion : currentVersion.substring(0, 7);
                    const availableShort = availableVersion.match(/^\d+\.\d+\.\d+/) ? availableVersion : availableVersion.substring(0, 7);

                    title.textContent = 'OTA Update Pending';
                    message.textContent = `${currentShort} â†’ ${availableShort} (${(firmware.size / 1024).toFixed(0)}KB) - Will install on next wake`;
                    banner.classList.remove('hidden');
                } else {
                    // Versions match - firmware is up to date
                    banner.classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to check OTA version:', error);
                banner.classList.add('hidden');
            }
        }

        // Load device status
        async function loadDeviceStatus() {
            try {
                const res = await fetch('/api/esp32-status');
                const s = await res.json();

                // Check how stale the data is
                const dataAge = s.lastSeen ? Date.now() - s.lastSeen : Infinity;
                const isStale = dataAge > 60 * 60 * 1000; // >1 hour old
                const isVeryStale = dataAge > 24 * 60 * 60 * 1000; // >1 day old

                // Status
                const stateEl = document.getElementById('deviceState');
                const isOnline = s.state === 'online';
                if (isOnline) {
                    stateEl.innerHTML = `<span class="status-dot online"></span>Online`;
                } else if (s.lastSeen) {
                    stateEl.innerHTML = `<span class="status-dot offline"></span>${timeAgo(s.lastSeen)}`;
                } else {
                    stateEl.innerHTML = `<span class="status-dot offline"></span>Never`;
                }

                // Battery
                const batteryEl = document.getElementById('batteryDisplay');
                const batteryStaleEl = document.getElementById('batteryStale');
                if (s.batteryVoltage) {
                    let bat = `${s.batteryVoltage}V`;
                    if (s.batteryPercent != null) bat += ` ${s.batteryPercent}%`;
                    if (s.isCharging) bat += ' âš¡';
                    batteryEl.textContent = bat;
                    batteryStaleEl.textContent = isStale ? `(${timeAgo(s.lastSeen)})` : '';
                } else {
                    batteryEl.textContent = '--';
                    batteryStaleEl.textContent = '';
                }

                // Signal
                document.getElementById('signalDisplay').textContent = s.signalStrength ? `${s.signalStrength}dBm` : '--';

                // Client firmware version
                const firmwareEl = document.getElementById('firmwareDisplay');
                if (s.firmwareVersion) {
                    formatVersionDisplay(firmwareEl, s.firmwareVersion, null);
                } else {
                    firmwareEl.textContent = '--';
                    firmwareEl.title = '';
                }

                // Check for OTA updates
                await checkOTAUpdate(s.firmwareVersion);

                // Next wake
                const card = document.getElementById('nextWakeCard');
                const timeEl = document.getElementById('nextWakeTime');
                const countdownEl = document.getElementById('nextWakeCountdown');

                if (s.lastSeen && s.sleepDuration) {
                    const nextWakeTs = s.lastSeen + (s.sleepDuration / 1000);
                    window.nextWakeTimestamp = nextWakeTs;

                    // If device is very stale, show offline state
                    if (isVeryStale) {
                        timeEl.textContent = '--:--';
                        countdownEl.textContent = `Device offline since ${timeAgo(s.lastSeen)}`;
                        card.className = 'next-wake-card offline';
                    } else {
                        updateNextWakeDisplay();
                    }
                } else {
                    window.nextWakeTimestamp = null;
                    timeEl.textContent = '--:--';
                    countdownEl.textContent = 'No data';
                    card.className = 'next-wake-card offline';
                }

                // Update battery graph
                updateBatteryGraph(s);

                // Update signal graph
                updateSignalGraph(s);

                // Update brownout history
                updateBrownoutHistory(s);

                // Update battery consumption by operation
                updateBatteryConsumption(s);

                // Update firmware efficiency comparison
                updateFirmwareAnalysis(s);

                // Update session history
                updateSessionHistory(s);

                // Update device stats
                updateDeviceStats(s);
            } catch (e) {
                console.error('Failed to load status:', e);
            }
        }

        // Update device stats row
        function updateDeviceStats(status) {
            const section = document.getElementById('statsSection');
            const stats = status.usageStats;

            // Only show if we have data
            if (!stats && !status.currentImage) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'flex';

            // Wakes and updates
            if (stats) {
                document.getElementById('statWakes').textContent = stats.totalWakes || 0;
                document.getElementById('statUpdates').textContent = stats.totalDisplayUpdates || 0;
            }

            // Brownout count (only show if > 0)
            const brownoutItem = document.getElementById('statBrownoutItem');
            const brownoutEl = document.getElementById('statBrownout');
            const brownoutCount = status.brownoutCount || 0;
            if (brownoutCount > 0) {
                brownoutItem.style.display = 'block';
                brownoutEl.textContent = brownoutCount;
            } else {
                brownoutItem.style.display = 'none';
            }

            // OTA history (only show if we have OTA events)
            const otaItem = document.getElementById('statOtaItem');
            const otaEl = document.getElementById('statOta');
            const otaHistory = status.otaHistory || [];
            if (otaHistory.length > 0) {
                const lastOta = otaHistory[otaHistory.length - 1];
                const timeStr = timeAgo(lastOta.timestamp);
                const statusStr = lastOta.success ? 'âœ…' : 'âŒ';
                otaEl.textContent = `${statusStr} ${timeStr}`;
                otaEl.title = lastOta.success
                    ? `OTA succeeded: ${lastOta.fromVersion} â†’ ${lastOta.toVersion}`
                    : `OTA failed: ${lastOta.error || 'Unknown error'}`;
                otaEl.className = lastOta.success ? 'stat-value' : 'stat-value stat-error';
                otaItem.style.display = 'block';
            } else {
                otaItem.style.display = 'none';
            }

            // Current image
            const imageEl = document.getElementById('statImage');
            if (status.currentImage) {
                // Truncate long titles
                const title = status.currentImage.length > 20
                    ? status.currentImage.substring(0, 18) + 'â€¦'
                    : status.currentImage;
                imageEl.textContent = title;
                imageEl.title = status.currentImage; // Full title on hover
            } else {
                imageEl.textContent = '--';
            }

            // Last error/issue (only show if there's an actual problem)
            const errorItem = document.getElementById('statErrorItem');
            const errorEl = document.getElementById('statError');
            const normalStatuses = ['ok', 'ready', 'no_update_needed', 'display_updated', 'sleeping', 'awake'];
            if (status.status && !normalStatuses.includes(status.status)) {
                errorItem.style.display = 'block';
                errorEl.textContent = status.status.replace(/_/g, ' ');
            } else {
                errorItem.style.display = 'none';
            }
        }

        // Render battery graph
        function updateBatteryGraph(status) {
            const section = document.getElementById('batteryGraphSection');
            const history = status.batteryHistory || [];

            if (history.length < 2) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Update header value with current status
            const valueEl = document.getElementById('batteryGraphValue');
            let valueClass = '';
            if (status.isCharging) valueClass = 'charging';
            else if (status.batteryPercent < 20) valueClass = 'critical';
            else if (status.batteryPercent < 40) valueClass = 'low';

            valueEl.className = 'battery-graph-value ' + valueClass;

            // Format estimated time remaining with confidence
            let timeRemaining = '';
            const est = status.batteryEstimate;
            if (est && !status.isCharging) {
                const hrs = est.hoursRemaining;
                if (hrs >= 48) {
                    timeRemaining = ` Â· ~${Math.round(hrs / 24)}d`;
                } else if (hrs >= 1) {
                    timeRemaining = ` Â· ~${hrs}h`;
                }
                // Show confidence indicator
                if (est.confidence < 50) {
                    timeRemaining += ' (learning)';
                }
            }

            valueEl.textContent = status.isCharging
                ? `${status.batteryVoltage}V âš¡ Charging`
                : `${status.batteryVoltage}V (${status.batteryPercent}%)${timeRemaining}`;

            // Calculate graph dimensions
            const width = 300;
            const height = 80;
            const padding = 4;

            // Find min/max voltage for scaling (with some padding)
            const voltages = history.map(h => h.voltage);
            const minV = Math.min(...voltages) - 0.1;
            const maxV = Math.max(...voltages) + 0.1;
            const range = maxV - minV || 0.5;

            // Generate path points
            const points = history.map((h, i) => {
                const x = padding + (i / (history.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((h.voltage - minV) / range) * (height - 2 * padding);
                return { x, y, charging: h.isCharging };
            });

            // Create line path
            const linePath = points.map((p, i) =>
                (i === 0 ? 'M' : 'L') + `${p.x.toFixed(1)},${p.y.toFixed(1)}`
            ).join(' ');

            // Create area path (for fill)
            const areaPath = linePath +
                ` L${points[points.length-1].x.toFixed(1)},${height} L${points[0].x.toFixed(1)},${height} Z`;

            // Update SVG paths
            document.getElementById('graphLine').setAttribute('d', linePath);
            document.getElementById('graphArea').setAttribute('d', areaPath);

            // Check if currently charging (green line)
            const graphLine = document.getElementById('graphLine');
            if (status.isCharging) {
                graphLine.classList.add('graph-charging');
            } else {
                graphLine.classList.remove('graph-charging');
            }

            // Update y-axis labels (voltage range)
            document.getElementById('graphVoltMax').textContent = maxV.toFixed(1) + 'V';
            document.getElementById('graphVoltMin').textContent = minV.toFixed(1) + 'V';

            // Update time labels
            if (history.length > 0) {
                const firstTime = new Date(history[0].timestamp);
                document.getElementById('graphTimeStart').textContent =
                    firstTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Render signal graph
        function updateSignalGraph(status) {
            const section = document.getElementById('signalGraphSection');
            const history = status.signalHistory || [];

            if (history.length < 2) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Update header value with signal quality
            const valueEl = document.getElementById('signalGraphValue');
            const rssi = status.signalStrength || 0;
            let quality = 'Good';
            let valueClass = 'signal-good';

            if (rssi >= -50) { quality = 'Excellent'; valueClass = 'signal-good'; }
            else if (rssi >= -60) { quality = 'Good'; valueClass = 'signal-good'; }
            else if (rssi >= -70) { quality = 'Fair'; valueClass = 'signal-fair'; }
            else { quality = 'Weak'; valueClass = 'signal-weak'; }

            valueEl.className = 'battery-graph-value ' + valueClass;
            valueEl.textContent = `${rssi}dBm (${quality})`;

            // Calculate graph dimensions
            const width = 300;
            const height = 80;
            const padding = 4;

            // Find min/max RSSI for scaling
            const values = history.map(h => h.rssi);
            const minR = Math.min(...values) - 5;
            const maxR = Math.max(...values) + 5;
            const range = maxR - minR || 10;

            // Generate path points
            const points = history.map((h, i) => {
                const x = padding + (i / (history.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((h.rssi - minR) / range) * (height - 2 * padding);
                return { x, y };
            });

            // Create line path
            const linePath = points.map((p, i) =>
                (i === 0 ? 'M' : 'L') + `${p.x.toFixed(1)},${p.y.toFixed(1)}`
            ).join(' ');

            // Create area path
            const areaPath = linePath +
                ` L${points[points.length-1].x.toFixed(1)},${height} L${points[0].x.toFixed(1)},${height} Z`;

            // Update SVG paths
            document.getElementById('signalLine').setAttribute('d', linePath);
            document.getElementById('signalArea').setAttribute('d', areaPath);

            // Update y-axis labels
            document.getElementById('signalGraphMax').textContent = maxR.toFixed(0) + 'dB';
            document.getElementById('signalGraphMin').textContent = minR.toFixed(0) + 'dB';

            // Update time labels
            if (history.length > 0) {
                const firstTime = new Date(history[0].timestamp);
                document.getElementById('signalTimeStart').textContent =
                    firstTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Update brownout history section
        function updateBrownoutHistory(status) {
            const section = document.getElementById('brownoutSection');
            const brownoutHistory = status.brownoutHistory || [];
            const brownoutCount = status.brownoutCount || 0;

            // Hide section if no brownouts
            if (brownoutCount === 0 && brownoutHistory.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            document.getElementById('brownoutHeaderCount').textContent = brownoutCount;

            // Calculate summary stats
            if (brownoutHistory.length > 0) {
                // Average voltage at brownout
                const avgVoltage = brownoutHistory.reduce((sum, b) => sum + (b.batteryVoltage || 0), 0) / brownoutHistory.length;
                document.getElementById('brownoutAvgVoltage').textContent = avgVoltage.toFixed(2) + 'V';

                // Last brownout time
                const lastBrownout = brownoutHistory[brownoutHistory.length - 1];
                document.getElementById('brownoutLastTime').textContent = timeAgo(lastBrownout.timestamp);

                // Populate table (newest first)
                const tbody = document.getElementById('brownoutTableBody');
                tbody.innerHTML = brownoutHistory.slice().reverse().map(b => {
                    const time = new Date(b.timestamp).toLocaleString('en-GB', {
                        month: 'short', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const voltage = b.batteryVoltage ? b.batteryVoltage.toFixed(2) + 'V' : '--';
                    const percent = b.batteryPercent != null ? b.batteryPercent + '%' : (b.isCharging ? 'âš¡' : '--');
                    const voltageClass = b.batteryVoltage < 3.5 ? 'voltage-critical' :
                                        b.batteryVoltage < 3.7 ? 'voltage-low' : 'voltage-ok';
                    const statusText = (b.status || 'unknown').replace(/_/g, ' ');
                    return `<tr>
                        <td>${time}</td>
                        <td class="${voltageClass}">${voltage}</td>
                        <td>${percent}</td>
                        <td>${statusText}</td>
                    </tr>`;
                }).join('');
            } else {
                document.getElementById('brownoutAvgVoltage').textContent = '--';
                document.getElementById('brownoutLastTime').textContent = '--';
                document.getElementById('brownoutTableBody').innerHTML =
                    '<tr><td colspan="4" style="text-align:center;color:#999">No history recorded yet</td></tr>';
            }
        }

        // Update battery consumption per operation
        function updateBatteryConsumption(status) {
            const section = document.getElementById('consumptionSection');
            const stats = status.usageStats;

            // Hide section if no usage data
            if (!stats || stats.totalWakes < 3) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Calculate averages
            const displayUpdates = stats.totalDisplayUpdates || 0;
            const otaUpdates = stats.otaUpdateCount || 0;
            const normalWakes = stats.totalWakes - displayUpdates - otaUpdates;

            const displayDrop = stats.displayUpdateVoltageDrop || 0;
            const otaDrop = stats.otaUpdateVoltageDrop || 0;
            const wakeDrop = stats.nonDisplayVoltageDrop || 0;
            const totalDrop = stats.totalVoltageDrop || 0;

            // Calculate per-operation averages (in millivolts for readability)
            const avgDisplayDrop = displayUpdates > 0 ? (displayDrop / displayUpdates * 1000) : 0;
            const avgOtaDrop = otaUpdates > 0 ? (otaDrop / otaUpdates * 1000) : 0;
            const avgWakeDrop = normalWakes > 0 ? (wakeDrop / normalWakes * 1000) : 0;

            // Update total drop header
            document.getElementById('consumptionTotalDrop').textContent =
                `${(totalDrop * 1000).toFixed(0)}mV total`;

            // Display update consumption
            const displayEl = document.getElementById('consumptionDisplayDrop');
            displayEl.textContent = avgDisplayDrop > 0 ? avgDisplayDrop.toFixed(0) : '--';
            displayEl.className = 'consumption-value' + getConsumptionClass(avgDisplayDrop);
            document.getElementById('consumptionDisplayCount').textContent =
                `${displayUpdates} update${displayUpdates !== 1 ? 's' : ''}`;

            // Normal wake consumption
            const wakeEl = document.getElementById('consumptionWakeDrop');
            wakeEl.textContent = avgWakeDrop > 0 ? avgWakeDrop.toFixed(0) : '--';
            wakeEl.className = 'consumption-value' + getConsumptionClass(avgWakeDrop);
            document.getElementById('consumptionWakeCount').textContent =
                `${Math.max(0, normalWakes)} wake${normalWakes !== 1 ? 's' : ''}`;

            // OTA update consumption
            const otaEl = document.getElementById('consumptionOtaDrop');
            otaEl.textContent = avgOtaDrop > 0 ? avgOtaDrop.toFixed(0) : '--';
            otaEl.className = 'consumption-value' + getConsumptionClass(avgOtaDrop);
            document.getElementById('consumptionOtaCount').textContent =
                `${otaUpdates} update${otaUpdates !== 1 ? 's' : ''}`;
        }

        // Get CSS class based on consumption level
        function getConsumptionClass(mvDrop) {
            if (mvDrop > 50) return ' high';
            if (mvDrop > 20) return ' medium';
            if (mvDrop > 0) return ' low';
            return '';
        }

        // Update firmware efficiency comparison
        function updateFirmwareAnalysis(status) {
            const section = document.getElementById('firmwareSection');
            const analysis = status.firmwareAnalysis || [];

            if (analysis.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Calculate total samples
            const totalSamples = analysis.reduce((sum, f) => sum + f.totalSamples, 0);
            document.getElementById('firmwareSampleCount').textContent = `${totalSamples} samples`;

            // Find best display efficiency for comparison
            const displayEfficiencies = analysis.filter(f => f.avgDisplayDropMv !== null).map(f => f.avgDisplayDropMv);
            const bestDisplay = displayEfficiencies.length > 0 ? Math.min(...displayEfficiencies) : null;

            // Find best wake efficiency
            const wakeEfficiencies = analysis.filter(f => f.avgWakeDropMv !== null).map(f => f.avgWakeDropMv);
            const bestWake = wakeEfficiencies.length > 0 ? Math.min(...wakeEfficiencies) : null;

            // Build table
            const tbody = document.getElementById('firmwareTableBody');
            tbody.innerHTML = analysis.map(f => {
                const version = f.version.length > 7 ? f.version.substring(0, 7) : f.version;
                const isCurrent = f.version === status.firmwareVersion;

                // Display drop with efficiency indicator
                let displayCell = '--';
                if (f.avgDisplayDropMv !== null) {
                    const cls = f.avgDisplayDropMv === bestDisplay ? 'efficiency-better' :
                               (bestDisplay && f.avgDisplayDropMv > bestDisplay * 1.2 ? 'efficiency-worse' : '');
                    displayCell = `<span class="${cls}">${f.avgDisplayDropMv}</span>`;
                }

                // Wake drop with efficiency indicator
                let wakeCell = '--';
                if (f.avgWakeDropMv !== null) {
                    const cls = f.avgWakeDropMv === bestWake ? 'efficiency-better' :
                               (bestWake && f.avgWakeDropMv > bestWake * 1.2 ? 'efficiency-worse' : '');
                    wakeCell = `<span class="${cls}">${f.avgWakeDropMv}</span>`;
                }

                const activeTime = timeAgo(f.lastSeen);

                return `<tr class="${isCurrent ? 'firmware-current' : ''}">
                    <td class="firmware-version">${version}${isCurrent ? ' âœ“' : ''}</td>
                    <td>${displayCell}</td>
                    <td>${wakeCell}</td>
                    <td>${f.totalSamples}</td>
                    <td>${activeTime}</td>
                </tr>`;
            }).join('');
        }

        // Update session history
        function updateSessionHistory(status) {
            const section = document.getElementById('sessionSection');
            const sessions = status.batterySessions || [];
            const currentSession = status.currentSession;

            if (sessions.length === 0 && !currentSession) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            document.getElementById('sessionCount').textContent = `${sessions.length} cycles`;

            const sessionList = document.getElementById('sessionList');
            let html = '';

            // Show current session first if exists
            if (currentSession && currentSession.startTime) {
                const startDate = new Date(currentSession.startTime).toLocaleString('en-GB', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const duration = formatDuration(Date.now() - currentSession.startTime);
                const voltageDrop = currentSession.startVoltage - status.batteryVoltage;

                html += `<div class="session-card" style="border-color: #10b981;">
                    <div class="session-header">
                        <span class="session-date">ðŸ”‹ Current Cycle (since ${startDate})</span>
                        <span class="session-duration">${duration}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat"><span class="session-stat-value">${currentSession.wakes || 0}</span> wakes</div>
                        <div class="session-stat"><span class="session-stat-value">${currentSession.displayUpdates || 0}</span> displays</div>
                        <div class="session-stat"><span class="session-stat-value">${(voltageDrop * 1000).toFixed(0)}mV</span> drop</div>
                        <div class="session-stat">${currentSession.startVoltage.toFixed(2)}V â†’ ${status.batteryVoltage.toFixed(2)}V</div>
                    </div>
                    <div class="session-firmware">Firmware: ${(currentSession.firmwareVersions || []).map(v => v.substring(0, 7)).join(', ')}</div>
                </div>`;
            }

            // Show past sessions (newest first)
            sessions.slice().reverse().slice(0, 10).forEach(s => {
                const startDate = new Date(s.startTime).toLocaleString('en-GB', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const duration = formatDuration(s.duration || 0);
                const voltageDrop = (s.startVoltage || 0) - (s.endVoltage || 0);

                html += `<div class="session-card">
                    <div class="session-header">
                        <span class="session-date">${startDate}</span>
                        <span class="session-duration">${duration}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat"><span class="session-stat-value">${s.wakes || 0}</span> wakes</div>
                        <div class="session-stat"><span class="session-stat-value">${s.displayUpdates || 0}</span> displays</div>
                        <div class="session-stat"><span class="session-stat-value">${(voltageDrop * 1000).toFixed(0)}mV</span> drop</div>
                        <div class="session-stat">${(s.startVoltage || 0).toFixed(2)}V â†’ ${(s.endVoltage || 0).toFixed(2)}V</div>
                    </div>
                    <div class="session-firmware">Firmware: ${(s.firmwareVersions || []).map(v => v.substring(0, 7)).join(', ')}</div>
                </div>`;
            });

            sessionList.innerHTML = html || '<div style="color:#999;text-align:center;padding:16px">No session history yet</div>';
        }

        // Format duration helper
        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            if (hours >= 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        // Load logs
        async function loadLogs() {
            try {
                const res = await fetch('/api/device-logs-combined?limit=30');
                const data = await res.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    document.getElementById('logOutput').innerHTML = '<div style="color:#666">No logs</div>';
                    return;
                }

                let html = '';
                logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                    const isError = log.level === 'ERROR' || log.message.toLowerCase().includes('error');
                    html += `<div class="log-entry ${isError ? 'log-error' : ''}">
                        <span class="log-time">${time}</span>${log.message}
                    </div>`;
                });
                document.getElementById('logOutput').innerHTML = html;
            } catch (e) {
                document.getElementById('logOutput').innerHTML = '<div style="color:#ef4444">Error loading logs</div>';
            }
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const res = await fetch('/api/system-info');
                const info = await res.json();
                const hours = Math.floor(info.uptime / 3600);
                const mins = Math.floor((info.uptime % 3600) / 60);
                document.getElementById('serverInfo').innerHTML =
                    `${info.version || 'local'} Â· Node ${info.nodeVersion} Â· Up ${hours}h ${mins}m`;
            } catch (e) {
                document.getElementById('serverInfo').textContent = 'Server info unavailable';
            }
        }

        // Live countdown for next wake
        function updateNextWakeDisplay() {
            if (!window.nextWakeTimestamp) return;

            const now = Date.now();
            const diffMs = window.nextWakeTimestamp - now;
            const card = document.getElementById('nextWakeCard');
            const timeEl = document.getElementById('nextWakeTime');
            const countdownEl = document.getElementById('nextWakeCountdown');

            // Show the actual wake time
            const wakeDate = new Date(window.nextWakeTimestamp);
            timeEl.textContent = wakeDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            if (diffMs > 0) {
                // Countdown
                const totalSecs = Math.floor(diffMs / 1000);
                const mins = Math.floor(totalSecs / 60);
                const secs = totalSecs % 60;

                if (mins >= 60) {
                    const hrs = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    countdownEl.textContent = `in ${hrs}h ${remainMins}m`;
                } else if (mins > 0) {
                    countdownEl.textContent = `in ${mins}m ${secs}s`;
                } else {
                    countdownEl.textContent = `in ${secs}s`;
                }

                // Add "soon" class if less than 2 minutes
                card.className = mins < 2 ? 'next-wake-card soon' : 'next-wake-card';
            } else {
                // Overdue
                const overdueMins = Math.floor(Math.abs(diffMs) / 60000);
                if (overdueMins > 60) {
                    countdownEl.textContent = `${Math.floor(overdueMins / 60)}h overdue`;
                } else {
                    countdownEl.textContent = overdueMins < 1 ? 'waking now...' : `${overdueMins}m overdue`;
                }
                card.className = 'next-wake-card overdue';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadDeviceStatus();
            loadSystemInfo();
            loadLogs();
            updateServerVersion();
            setInterval(loadDeviceStatus, 10000);
            setInterval(updateNextWakeDisplay, 1000);
        });
    </script>
</body>
</html>
