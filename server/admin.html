<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Glance - Admin</title>
    <style>
        /* Light mode (default) */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #fafafa;
            --bg-logs: #1a1a1a;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-primary: #e5e5e5;
            --border-secondary: #f0f0f0;
            --button-bg: #1a1a1a;
            --button-text: #ffffff;
            --button-hover: #333;
            --input-bg: #ffffff;
            --input-border: #e5e5e5;
            --input-border-focus: #1a1a1a;
            --logs-bg: #1a1a1a;
            --logs-bg-secondary: #2a2a2a;
            --logs-border: #444;
            --logs-text: #e5e5e5;
            --logs-text-dim: #999;
            --scrollbar-track: #0a0a0a;
            --scrollbar-thumb: #333;
            --scrollbar-thumb-hover: #444;
        }

        /* Dark mode (system preference) */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2a2a2a;
                --bg-tertiary: #252525;
                --bg-logs: #0a0a0a;
                --text-primary: #e5e5e5;
                --text-secondary: #b0b0b0;
                --text-tertiary: #888;
                --border-primary: #404040;
                --border-secondary: #333;
                --button-bg: #e5e5e5;
                --button-text: #1a1a1a;
                --button-hover: #d0d0d0;
                --input-bg: #2a2a2a;
                --input-border: #404040;
                --input-border-focus: #e5e5e5;
                --logs-bg: #0a0a0a;
                --logs-bg-secondary: #1a1a1a;
                --logs-border: #333;
                --logs-text: #e5e5e5;
                --logs-text-dim: #888;
                --scrollbar-track: #0a0a0a;
                --scrollbar-thumb: #333;
                --scrollbar-thumb-hover: #444;
            }
        }

        /* Dark mode (manual override) */
        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #252525;
            --bg-logs: #0a0a0a;
            --text-primary: #e5e5e5;
            --text-secondary: #b0b0b0;
            --text-tertiary: #888;
            --border-primary: #404040;
            --border-secondary: #333;
            --button-bg: #e5e5e5;
            --button-text: #1a1a1a;
            --button-hover: #d0d0d0;
            --input-bg: #2a2a2a;
            --input-border: #404040;
            --input-border-focus: #e5e5e5;
            --logs-bg: #0a0a0a;
            --logs-bg-secondary: #1a1a1a;
            --logs-border: #333;
            --logs-text: #e5e5e5;
            --logs-text-dim: #888;
            --scrollbar-track: #0a0a0a;
            --scrollbar-thumb: #333;
            --scrollbar-thumb-hover: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 40px;
            text-align: center;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 30px 0 16px 0;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        /* Device Status */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 40px;
        }

        .status-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .status-value {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .status-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .status-online { color: #10b981; }
        .status-offline { color: #6b7280; }

        /* Logs */
        .logs-container {
            background: var(--logs-bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 40px;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .logs-title {
            color: var(--logs-text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logs-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .log-filter {
            background: var(--logs-bg-secondary);
            border: 1px solid var(--logs-border);
            color: var(--logs-text);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .log-search {
            background: var(--logs-bg-secondary);
            border: 1px solid var(--logs-border);
            color: var(--logs-text);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            min-width: 200px;
        }

        .log-search::placeholder {
            color: var(--text-secondary);
        }

        .log-btn {
            background: var(--logs-bg-secondary);
            border: 1px solid var(--logs-border);
            color: var(--logs-text-dim);
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .log-btn:hover {
            background: var(--logs-border);
            color: var(--logs-text);
        }

        .log-output {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.75rem;
            color: var(--logs-text);
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-output::-webkit-scrollbar {
            width: 8px;
        }

        .log-output::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        .log-output::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .log-output::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Enhanced log output with structured entries */
        .log-output-enhanced {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-output-enhanced::-webkit-scrollbar {
            width: 8px;
        }

        .log-output-enhanced::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .log-output-enhanced::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .log-entry:hover {
            background: #2a2a2a;
        }

        .log-timestamp {
            color: #666;
            font-size: 0.7rem;
            white-space: nowrap;
            min-width: 80px;
        }

        .log-level {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 50px;
            text-align: center;
        }

        .log-level-INFO {
            background: #1e40af20;
            color: #60a5fa;
        }

        .log-level-ERROR {
            background: #dc262620;
            color: #ef4444;
        }

        .log-level-WARNING {
            background: #d9770620;
            color: #f59e0b;
        }

        .log-source {
            font-size: 0.65rem;
            color: #888;
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
        }

        .log-message {
            color: #e5e5e5;
            flex: 1;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Recent activity timeline */
        .activity-container {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 40px;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .activity-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }

        .activity-item {
            background: #fff;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-left: 3px solid transparent;
        }

        .activity-item:hover {
            background: #fafafa;
        }

        .activity-item.success {
            border-left-color: #10b981;
        }

        .activity-item.failure {
            border-left-color: #ef4444;
        }

        .activity-item.incomplete {
            border-left-color: #f59e0b;
        }

        .activity-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            min-width: 100px;
        }

        .activity-stats {
            display: flex;
            gap: 16px;
            align-items: center;
            flex: 1;
            font-size: 0.75rem;
        }

        .activity-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .activity-stat-label {
            color: #999;
        }

        .activity-stat-value {
            color: #333;
            font-weight: 500;
        }

        .activity-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .activity-badge.success {
            background: #10b98120;
            color: #10b981;
        }

        .activity-badge.failure {
            background: #ef444420;
            color: #ef4444;
        }

        .activity-badge.incomplete {
            background: #f59e0b20;
            color: #f59e0b;
        }

        /* Wake cycle diagnostics */
        .diagnostic-container {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 40px;
        }

        .diagnostic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .diagnostic-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }

        .diagnostic-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .diagnostic-stat {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .diagnostic-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .diagnostic-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline {
            background: #fff;
            border-radius: 6px;
            padding: 16px;
        }

        .timeline-event {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px 0;
            border-left: 2px solid #e5e5e5;
            padding-left: 16px;
            margin-left: 6px;
            position: relative;
        }

        .timeline-event::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 12px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid #fff;
        }

        .timeline-event.error::before {
            background: #ef4444;
        }

        .timeline-event.error {
            border-left-color: #ef4444;
        }

        .timeline-time {
            color: #666;
            font-size: 0.7rem;
            font-family: 'SF Mono', monospace;
            min-width: 60px;
        }

        .timeline-message {
            flex: 1;
            font-size: 0.8rem;
            color: #333;
            line-height: 1.5;
        }

        /* Back link */
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        /* System info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 40px;
        }

        .info-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px 16px;
        }

        .info-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.9rem;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        /* Settings */
        .settings-form {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--input-border-focus);
        }

        .form-hint {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--button-hover);
        }

        .btn-primary:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
        }

        .success-message {
            color: #10b981;
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: var(--input-bg);
            border: 1px solid var(--border-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .preset-btn:hover {
            border-color: var(--input-border-focus);
            background: var(--bg-tertiary);
        }

        /* Server identification */
        .server-id {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-align: center;
            margin-bottom: 24px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        /* Statistics */
        .stats-container {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 40px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-controls {
            display: flex;
            gap: 8px;
        }

        .stats-btn {
            background: #fff;
            border: 1px solid #e5e5e5;
            color: #666;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-btn:hover {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        .stats-btn.active {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-sublabel {
            color: #999;
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .api-source-list {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .api-source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .api-source-item:last-child {
            border-bottom: none;
        }

        .api-source-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .api-source-stats {
            display: flex;
            gap: 16px;
            font-size: 0.75rem;
            color: #666;
        }

        .api-bar {
            background: #f0f0f0;
            height: 8px;
            border-radius: 4px;
            margin-top: 4px;
            position: relative;
            overflow: hidden;
        }

        .api-bar-fill {
            background: #1a1a1a;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .log-chart {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .chart-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .chart-label {
            width: 60px;
            font-size: 0.75rem;
            color: #666;
        }

        .chart-bar-bg {
            flex: 1;
            background: #f0f0f0;
            height: 24px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar-fill {
            background: #1a1a1a;
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 40px;
        }

        .info-item {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .info-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 16px;
                overflow-x: hidden;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.2rem;
                margin-top: 32px;
            }

            .stats-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .stats-controls {
                flex-wrap: wrap;
                width: 100%;
            }

            .stats-btn {
                flex: 1;
                min-width: 70px;
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .api-source-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .api-source-stats {
                flex-wrap: wrap;
                gap: 12px;
                font-size: 0.7rem;
            }

            .log-output {
                font-size: 0.7rem;
            }

            .settings-group {
                margin-bottom: 20px;
            }

            input[type="number"],
            input[type="text"],
            select {
                font-size: 16px; /* Prevents iOS zoom on input focus */
            }

            /* Stack device status on mobile */
            .device-status {
                flex-direction: column;
                gap: 16px;
            }

            .status-item {
                min-width: 100%;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            .stats-btn {
                font-size: 0.65rem;
                padding: 5px 6px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .api-source-name {
                font-size: 0.8rem;
            }

            .chart-label {
                width: 50px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-link">← back</a>

    <h1>Admin</h1>

    <!-- Server identification -->
    <div class="server-id" id="serverId"></div>

    <h2>Wake Schedule</h2>
    <div class="settings-form">
        <div class="form-group">
            <label class="form-label" for="sleepDuration">Update Interval (minutes)</label>
            <input type="number" id="sleepDuration" class="form-input" min="5" max="1440" step="1" placeholder="60">
            <div class="form-hint">
                ESP32 wakes at clock-aligned intervals. For example, with 30 minutes it wakes at :00 and :30 of each hour, not at random times like 12:02 or 12:32.
            </div>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="setSleepPreset(5)">5 min</button>
                <button class="preset-btn" onclick="setSleepPreset(15)">15 min</button>
                <button class="preset-btn" onclick="setSleepPreset(30)">30 min</button>
                <button class="preset-btn" onclick="setSleepPreset(60)">1 hour</button>
                <button class="preset-btn" onclick="setSleepPreset(120)">2 hours</button>
                <button class="preset-btn" onclick="setSleepPreset(360)">6 hours</button>
                <button class="preset-btn" onclick="setSleepPreset(720)">12 hours</button>
                <button class="preset-btn" onclick="setSleepPreset(1440)">24 hours</button>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: #fff; border-radius: 4px; font-size: 0.85rem; color: #666;">
                <strong>Next wake times:</strong> <span id="nextWakeTimes">--</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="devMode" style="margin-right: 8px; width: auto;">
                Development Mode
            </label>
            <div class="form-hint" id="devModeHint">
                ESP32 will try dev server first, fallback to production if unreachable. Auto-disables if dev server is down.
            </div>
        </div>

        <div class="form-group" id="devServerHostGroup" style="display: none;">
            <label class="form-label" for="devServerHost">Development Server Host</label>
            <input type="text" id="devServerHost" class="form-input" placeholder="192.168.1.100:3000">
            <div class="form-hint">
                Your development laptop IP and port (auto-detected).
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="defaultOrientation">Default Display Orientation</label>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="preset-btn" id="orientationPortrait" onclick="selectOrientation('portrait')" style="flex: 1;">
                    Portrait (1200×1600)
                </button>
                <button type="button" class="preset-btn" id="orientationLandscape" onclick="selectOrientation('landscape')" style="flex: 1;">
                    Landscape (1600×1200)
                </button>
            </div>
            <div class="form-hint">
                Default orientation for image previews and AI generation.
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Interface Theme</label>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="preset-btn" id="themeAuto" onclick="selectTheme('auto')" style="flex: 1;">
                    Auto (System)
                </button>
                <button type="button" class="preset-btn" id="themeLight" onclick="selectTheme('light')" style="flex: 1;">
                    Light
                </button>
                <button type="button" class="preset-btn" id="themeDark" onclick="selectTheme('dark')" style="flex: 1;">
                    Dark
                </button>
            </div>
            <div class="form-hint">
                Choose interface theme or follow system preference.
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="nightSleepEnabled" onchange="toggleNightSleepInputs()" style="margin-right: 8px; width: auto;">
                Night Sleep
            </label>
            <div class="form-hint">
                Keep display asleep during nighttime hours.
            </div>
            <div id="nightSleepInputs" style="display: none; margin-top: 12px;">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="flex: 1;">
                        <label class="form-label" for="nightSleepStartHour" style="margin-bottom: 4px;">From</label>
                        <select id="nightSleepStartHour" class="form-input">
                            <option value="0">00:00 (12 AM)</option>
                            <option value="1">01:00 (1 AM)</option>
                            <option value="2">02:00 (2 AM)</option>
                            <option value="3">03:00 (3 AM)</option>
                            <option value="4">04:00 (4 AM)</option>
                            <option value="5">05:00 (5 AM)</option>
                            <option value="6">06:00 (6 AM)</option>
                            <option value="7">07:00 (7 AM)</option>
                            <option value="8">08:00 (8 AM)</option>
                            <option value="9">09:00 (9 AM)</option>
                            <option value="10">10:00 (10 AM)</option>
                            <option value="11">11:00 (11 AM)</option>
                            <option value="12">12:00 (12 PM)</option>
                            <option value="13">13:00 (1 PM)</option>
                            <option value="14">14:00 (2 PM)</option>
                            <option value="15">15:00 (3 PM)</option>
                            <option value="16">16:00 (4 PM)</option>
                            <option value="17">17:00 (5 PM)</option>
                            <option value="18">18:00 (6 PM)</option>
                            <option value="19">19:00 (7 PM)</option>
                            <option value="20">20:00 (8 PM)</option>
                            <option value="21">21:00 (9 PM)</option>
                            <option value="22">22:00 (10 PM)</option>
                            <option value="23">23:00 (11 PM)</option>
                        </select>
                    </div>
                    <div style="padding-top: 20px; color: #999;">—</div>
                    <div style="flex: 1;">
                        <label class="form-label" for="nightSleepEndHour" style="margin-bottom: 4px;">To</label>
                        <select id="nightSleepEndHour" class="form-input">
                            <option value="0">00:00 (12 AM)</option>
                            <option value="1">01:00 (1 AM)</option>
                            <option value="2">02:00 (2 AM)</option>
                            <option value="3">03:00 (3 AM)</option>
                            <option value="4">04:00 (4 AM)</option>
                            <option value="5">05:00 (5 AM)</option>
                            <option value="6">06:00 (6 AM)</option>
                            <option value="7">07:00 (7 AM)</option>
                            <option value="8">08:00 (8 AM)</option>
                            <option value="9">09:00 (9 AM)</option>
                            <option value="10">10:00 (10 AM)</option>
                            <option value="11">11:00 (11 AM)</option>
                            <option value="12">12:00 (12 PM)</option>
                            <option value="13">13:00 (1 PM)</option>
                            <option value="14">14:00 (2 PM)</option>
                            <option value="15">15:00 (3 PM)</option>
                            <option value="16">16:00 (4 PM)</option>
                            <option value="17">17:00 (5 PM)</option>
                            <option value="18">18:00 (6 PM)</option>
                            <option value="19">19:00 (7 PM)</option>
                            <option value="20">20:00 (8 PM)</option>
                            <option value="21">21:00 (9 PM)</option>
                            <option value="22">22:00 (10 PM)</option>
                            <option value="23">23:00 (11 PM)</option>
                        </select>
                    </div>
                </div>
                <div class="form-hint" style="margin-top: 8px;">
                    Display stays asleep during selected hours.
                </div>
            </div>
        </div>

        <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        <div class="success-message" id="successMessage">Settings saved! ESP32 will use new settings on next wake.</div>
    </div>

    <h2>Device Status</h2>
    <div class="status-grid">
        <div class="status-item">
            <div class="status-value" id="deviceState">--</div>
            <div class="status-label">Status</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="batteryVoltage">--V</div>
            <div class="status-label">Battery</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="lastCharged">--</div>
            <div class="status-label">Last Charged</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="signalStrength">--</div>
            <div class="status-label">Signal</div>
        </div>
        <div class="status-item">
            <div class="status-value" id="nextWake">--</div>
            <div class="status-label">Next Update</div>
        </div>
    </div>

    <h2>System Information</h2>
    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">Server Version</div>
            <div class="info-value" id="serverVersion">--</div>
        </div>
        <div class="info-item">
            <div class="info-label">Node.js Version</div>
            <div class="info-value" id="nodeVersion">--</div>
        </div>
        <div class="info-item">
            <div class="info-label">Uptime</div>
            <div class="info-value" id="uptime">--</div>
        </div>
        <div class="info-item">
            <div class="info-label">Platform</div>
            <div class="info-value" id="platform">--</div>
        </div>
    </div>


    <h2>Recent Wake Cycles</h2>
    <div class="activity-container">
        <div class="activity-header">
            <div class="activity-title">Last 10 Wake Cycles</div>
            <button class="log-btn" onclick="refreshRecentActivity()">Refresh</button>
        </div>
        <div id="recentActivityList">Loading activity...</div>
    </div>

    <h2>Latest Wake Cycle Details</h2>
    <div class="diagnostic-container">
        <div class="diagnostic-header">
            <div class="diagnostic-title">Event Timeline</div>
            <button class="log-btn" onclick="refreshWakeCycle()">Refresh</button>
        </div>
        <div id="wakeCycleTimeline">Loading diagnostics...</div>
    </div>

    <h2>Device Logs</h2>
    <div class="logs-container">
        <div class="logs-header">
            <div class="logs-title">Combined ESP32 + Server Activity</div>
            <div class="logs-controls">
                <select id="logLevelFilter" class="log-filter" onchange="loadCombinedLogs()">
                    <option value="">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <input type="text" id="logSearchInput" class="log-search" placeholder="Search logs..." onkeyup="filterLogs()">
                <button class="log-btn" onclick="loadCombinedLogs()">Refresh</button>
                <button class="log-btn" id="autoRefreshBtn" onclick="toggleAutoRefresh()">Auto: Off</button>
            </div>
        </div>
        <div class="log-output-enhanced" id="combinedLogOutput">Loading logs...</div>
    </div>

    <h2>Server Console</h2>
    <div class="logs-container" style="margin-bottom: 40px;">
        <div class="logs-header">
            <div class="logs-title">Server Debug Output (Last 100 entries)</div>
            <div class="logs-controls">
                <button class="log-btn" onclick="loadServerLogs()">Refresh</button>
                <button class="log-btn" onclick="clearServerLogs()">Clear Display</button>
            </div>
        </div>
        <div class="log-output-enhanced" id="serverLogOutput">Loading server logs...</div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let selectedOrientation = 'portrait'; // Default orientation

        // Theme management
        function initTheme() {
            // Check for saved theme preference or default to system preference
            const savedTheme = localStorage.getItem('theme');
            const root = document.documentElement;

            if (savedTheme && savedTheme !== 'auto') {
                root.setAttribute('data-theme', savedTheme);
            } else {
                root.removeAttribute('data-theme');
            }

            // Update button styles
            updateThemeButtons(savedTheme || 'auto');
        }

        function selectTheme(theme) {
            const root = document.documentElement;

            if (theme === 'auto') {
                root.removeAttribute('data-theme');
                localStorage.removeItem('theme');
            } else {
                root.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            updateThemeButtons(theme);
        }

        function updateThemeButtons(selectedTheme) {
            const autoBtn = document.getElementById('themeAuto');
            const lightBtn = document.getElementById('themeLight');
            const darkBtn = document.getElementById('themeDark');

            // Reset all buttons
            [autoBtn, lightBtn, darkBtn].forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
                btn.style.borderColor = '';
            });

            // Highlight selected button
            let activeBtn;
            if (selectedTheme === 'auto') activeBtn = autoBtn;
            else if (selectedTheme === 'light') activeBtn = lightBtn;
            else if (selectedTheme === 'dark') activeBtn = darkBtn;

            if (activeBtn) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
                              (selectedTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                activeBtn.style.background = isDark ? '#e5e5e5' : '#1a1a1a';
                activeBtn.style.color = isDark ? '#1a1a1a' : '#fff';
                activeBtn.style.borderColor = isDark ? '#e5e5e5' : '#1a1a1a';
            }
        }

        // Select orientation
        function selectOrientation(orientation) {
            selectedOrientation = orientation;

            // Update button styles
            const portraitBtn = document.getElementById('orientationPortrait');
            const landscapeBtn = document.getElementById('orientationLandscape');

            if (orientation === 'portrait') {
                portraitBtn.style.background = '#1a1a1a';
                portraitBtn.style.color = '#fff';
                landscapeBtn.style.background = '';
                landscapeBtn.style.color = '';
            } else {
                landscapeBtn.style.background = '#1a1a1a';
                landscapeBtn.style.color = '#fff';
                portraitBtn.style.background = '';
                portraitBtn.style.color = '';
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                // Convert microseconds to minutes
                const minutes = Math.round(settings.defaultSleepDuration / 1000000 / 60);
                document.getElementById('sleepDuration').value = minutes;

                // Load dev mode settings (default to true if not set)
                const devMode = settings.devMode !== undefined ? settings.devMode : true;
                document.getElementById('devMode').checked = devMode;
                document.getElementById('devServerHost').value = settings.devServerHost || '';

                // Load orientation setting (default to portrait if not set)
                const orientation = settings.defaultOrientation || 'portrait';
                selectOrientation(orientation);

                // Load night sleep settings (default to disabled)
                const nightSleepEnabled = settings.nightSleepEnabled || false;
                document.getElementById('nightSleepEnabled').checked = nightSleepEnabled;
                document.getElementById('nightSleepStartHour').value = settings.nightSleepStartHour || 23;
                document.getElementById('nightSleepEndHour').value = settings.nightSleepEndHour || 5;
                toggleNightSleepInputs();

                // Show/hide dev server host field based on dev mode
                toggleDevServerHost();

                // Calculate and show next wake times
                updateNextWakeTimes(minutes);
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // Initialize server identification
        function initServerId() {
            const serverId = document.getElementById('serverId');
            const hostname = window.location.hostname;
            const isProduction = hostname.includes('serverpi') || hostname.includes('raspberrypi');

            if (isProduction) {
                serverId.textContent = 'production: ' + window.location.host;
            } else {
                serverId.textContent = 'development: ' + window.location.host;

                // Hide dev mode settings on development server
                // (only production server should control where ESP32 connects)
                const devModeGroup = document.querySelector('.form-group:has(#devMode)');
                const devServerHostGroup = document.getElementById('devServerHostGroup');
                if (devModeGroup) devModeGroup.style.display = 'none';
                if (devServerHostGroup) devServerHostGroup.style.display = 'none';
            }
        }

        // Toggle dev server host visibility and auto-fill IP
        async function toggleDevServerHost() {
            const devMode = document.getElementById('devMode').checked;
            const hostGroup = document.getElementById('devServerHostGroup');
            const hostInput = document.getElementById('devServerHost');

            hostGroup.style.display = devMode ? 'block' : 'none';

            // Auto-fill client IP when toggling dev mode ON
            if (devMode && !hostInput.value) {
                try {
                    const response = await fetch('/api/client-ip');
                    const data = await response.json();
                    if (data.ip && !data.ip.startsWith('::')) {
                        hostInput.value = data.ip + ':3000';
                        hostInput.placeholder = data.ip + ':3000';
                    }
                } catch (error) {
                    console.log('Could not auto-detect IP:', error);
                }
            }
        }

        // Toggle night sleep inputs visibility
        function toggleNightSleepInputs() {
            const enabled = document.getElementById('nightSleepEnabled').checked;
            const inputs = document.getElementById('nightSleepInputs');
            inputs.style.display = enabled ? 'block' : 'none';
        }

        // Calculate and display next wake times
        function updateNextWakeTimes(intervalMinutes) {
            if (!intervalMinutes || intervalMinutes < 5) {
                document.getElementById('nextWakeTimes').textContent = '--';
                return;
            }

            const now = new Date();
            const intervalMs = intervalMinutes * 60 * 1000;
            const nowMs = now.getTime();

            // Calculate next 3 wake times
            const msSinceLastInterval = nowMs % intervalMs;
            const msUntilNext = intervalMs - msSinceLastInterval;

            const wakeTimes = [];
            for (let i = 0; i < 3; i++) {
                const wakeTime = new Date(nowMs + msUntilNext + (i * intervalMs));
                const timeStr = wakeTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                wakeTimes.push(timeStr);
            }

            document.getElementById('nextWakeTimes').textContent = wakeTimes.join(', ');
        }

        // Add event listener to dev mode checkbox
        document.addEventListener('DOMContentLoaded', () => {
            initServerId();
            document.getElementById('devMode').addEventListener('change', toggleDevServerHost);
        });

        // Set preset value
        function setSleepPreset(minutes) {
            document.getElementById('sleepDuration').value = minutes;
            updateNextWakeTimes(minutes);
        }

        // Save settings
        async function saveSettings() {
            try {
                const minutes = parseInt(document.getElementById('sleepDuration').value);

                if (!minutes || minutes < 5 || minutes > 1440) {
                    alert('Please enter a value between 5 and 1440 minutes');
                    return;
                }

                // Convert minutes to microseconds
                const microseconds = minutes * 60 * 1000000;

                // Get dev mode settings
                const devMode = document.getElementById('devMode').checked;
                const devServerHost = document.getElementById('devServerHost').value.trim();

                // Get night sleep settings
                const nightSleepEnabled = document.getElementById('nightSleepEnabled').checked;
                const nightSleepStartHour = parseInt(document.getElementById('nightSleepStartHour').value) || 23;
                const nightSleepEndHour = parseInt(document.getElementById('nightSleepEndHour').value) || 5;

                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        defaultSleepDuration: microseconds,
                        devMode: devMode,
                        devServerHost: devServerHost || undefined,
                        defaultOrientation: selectedOrientation,
                        nightSleepEnabled: nightSleepEnabled,
                        nightSleepStartHour: nightSleepStartHour,
                        nightSleepEndHour: nightSleepEndHour
                    })
                });

                if (response.ok) {
                    const successMsg = document.getElementById('successMessage');
                    successMsg.classList.add('show');
                    setTimeout(() => successMsg.classList.remove('show'), 3000);
                } else {
                    const error = await response.json();
                    alert('Failed to save settings: ' + error.error);
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('Failed to save settings');
            }
        }

        // Load device status
        async function loadDeviceStatus() {
            try {
                const response = await fetch('/api/esp32-status');
                const status = await response.json();

                document.getElementById('deviceState').textContent = status.state || 'Unknown';
                document.getElementById('deviceState').className =
                    status.state === 'online' ? 'status-value status-online' : 'status-value status-offline';

                // Battery display with percentage and charging indicator
                if (status.batteryVoltage) {
                    let batteryText = `${status.batteryVoltage}V`;
                    if (status.batteryPercent !== null && status.batteryPercent !== undefined) {
                        batteryText += ` (${status.batteryPercent}%)`;
                    }
                    if (status.isCharging) {
                        batteryText += ' ⚡';
                    }
                    document.getElementById('batteryVoltage').textContent = batteryText;
                } else {
                    document.getElementById('batteryVoltage').textContent = '--';
                }

                // Last charged display
                if (status.lastChargeTimestamp) {
                    const lastCharge = new Date(status.lastChargeTimestamp);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastCharge) / 1000 / 60);

                    if (diffMinutes < 1) {
                        document.getElementById('lastCharged').textContent = 'Just now';
                    } else if (diffMinutes < 60) {
                        document.getElementById('lastCharged').textContent = `${diffMinutes}m ago`;
                    } else if (diffMinutes < 1440) { // Less than 24 hours
                        const hours = Math.floor(diffMinutes / 60);
                        document.getElementById('lastCharged').textContent = `${hours}h ago`;
                    } else {
                        const days = Math.floor(diffMinutes / 1440);
                        document.getElementById('lastCharged').textContent = `${days}d ago`;
                    }
                } else {
                    document.getElementById('lastCharged').textContent = 'Never';
                }

                document.getElementById('signalStrength').textContent =
                    status.signalStrength ? `${status.signalStrength} dBm` : '--';

                // Calculate next wake time
                if (status.lastSeen && status.sleepDuration) {
                    const lastSeen = status.lastSeen;
                    const sleepDurationMs = status.sleepDuration / 1000; // Convert microseconds to milliseconds
                    const nextWakeTime = lastSeen + sleepDurationMs;
                    const now = Date.now();
                    const diffMs = nextWakeTime - now;

                    if (diffMs > 0) {
                        // Future wake time
                        const diffMinutes = Math.floor(diffMs / 1000 / 60);
                        if (diffMinutes < 1) {
                            document.getElementById('nextWake').textContent = 'Soon';
                        } else if (diffMinutes < 60) {
                            document.getElementById('nextWake').textContent = `${diffMinutes}m`;
                        } else {
                            const hours = Math.floor(diffMinutes / 60);
                            const minutes = diffMinutes % 60;
                            document.getElementById('nextWake').textContent = minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
                        }
                    } else {
                        // Past due (should have woken already)
                        const overdue = Math.floor(Math.abs(diffMs) / 1000 / 60);
                        document.getElementById('nextWake').textContent = overdue < 2 ? 'Now' : `Overdue ${overdue}m`;
                    }
                } else {
                    document.getElementById('nextWake').textContent = '--';
                }
            } catch (error) {
                console.error('Failed to load device status:', error);
            }
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system-info');
                const info = await response.json();

                // Format version with GitHub link if it's a SHA
                const versionEl = document.getElementById('serverVersion');
                const version = info.version || 'local';

                if (version.startsWith('sha-')) {
                    const sha = version.substring(4); // Remove 'sha-' prefix
                    versionEl.innerHTML = `<a href="https://github.com/CHaerem/Glance/commit/${sha}" target="_blank" style="color: #0969da; text-decoration: none;">${version}</a>`;
                } else {
                    versionEl.textContent = version;
                }

                document.getElementById('nodeVersion').textContent = info.nodeVersion || process.version;
                document.getElementById('platform').textContent = info.platform || navigator.platform;

                if (info.uptime) {
                    const hours = Math.floor(info.uptime / 3600);
                    const minutes = Math.floor((info.uptime % 3600) / 60);
                    document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
                }
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }


        // Combined logs storage for filtering
        let allCombinedLogs = [];

        // Load combined device logs (ESP32 + server activity)
        async function loadCombinedLogs() {
            try {
                const levelFilter = document.getElementById('logLevelFilter').value;
                const url = levelFilter ? `/api/device-logs-combined?limit=200&level=${levelFilter}` : '/api/device-logs-combined?limit=200';

                const response = await fetch(url);
                const data = await response.json();

                allCombinedLogs = data.logs || [];
                renderCombinedLogs(allCombinedLogs);
            } catch (error) {
                console.error('Failed to load combined logs:', error);
                document.getElementById('combinedLogOutput').innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading logs</div>';
            }
        }

        function renderCombinedLogs(logs) {
            const logOutput = document.getElementById('combinedLogOutput');

            if (logs.length === 0) {
                logOutput.innerHTML = '<div style="color: #666; padding: 12px;">No logs available</div>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                const timestamp = new Date(log.timestamp);
                const timeStr = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const errorClass = (log.level === 'ERROR' || log.message.toLowerCase().includes('error') || log.message.toLowerCase().includes('failed')) ? ' error' : '';

                html += `
                    <div class="log-entry${errorClass}">
                        <div class="log-timestamp">${timeStr}</div>
                        <div class="log-level log-level-${log.level}">${log.level}</div>
                        <div class="log-source">${log.source}</div>
                        <div class="log-message">${escapeHtml(log.message)}</div>
                    </div>
                `;
            });

            logOutput.innerHTML = html;
            // Auto-scroll to top (newest first)
            logOutput.scrollTop = 0;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function filterLogs() {
            const searchTerm = document.getElementById('logSearchInput').value.toLowerCase();

            if (!searchTerm) {
                renderCombinedLogs(allCombinedLogs);
                return;
            }

            const filtered = allCombinedLogs.filter(log =>
                log.message.toLowerCase().includes(searchTerm)
            );

            renderCombinedLogs(filtered);
        }

        // Recent activity timeline
        async function refreshRecentActivity() {
            try {
                const response = await fetch('/api/wake-cycle-diagnostics');
                const data = await response.json();

                const listElement = document.getElementById('recentActivityList');

                if (!data.recentCycles || data.recentCycles.length === 0) {
                    listElement.innerHTML = '<div style="color: #666; padding: 12px;">No wake cycle data available yet</div>';
                    return;
                }

                let html = '';
                data.recentCycles.forEach((cycle, index) => {
                    const startTime = new Date(cycle.startTime);
                    const timeStr = startTime.toLocaleString('en-GB', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const durationSec = Math.round(cycle.duration / 1000);
                    const errorCount = cycle.errors.length;
                    const status = cycle.incomplete ? 'incomplete' : (errorCount > 0 ? 'failure' : 'success');
                    const statusText = cycle.incomplete ? 'Active' : (errorCount > 0 ? 'Errors' : 'Success');

                    html += `
                        <div class="activity-item ${status}">
                            <div class="activity-summary">
                                <div class="activity-time">${timeStr}</div>
                                <div class="activity-stats">
                                    <div class="activity-stat">
                                        <span class="activity-stat-label">Duration:</span>
                                        <span class="activity-stat-value">${durationSec}s</span>
                                    </div>
                                    <div class="activity-stat">
                                        <span class="activity-stat-label">Events:</span>
                                        <span class="activity-stat-value">${cycle.events.length}</span>
                                    </div>
                                    ${errorCount > 0 ? `
                                    <div class="activity-stat">
                                        <span class="activity-stat-label">Errors:</span>
                                        <span class="activity-stat-value" style="color: #ef4444;">${errorCount}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="activity-badge ${status}">${statusText}</div>
                            </div>
                        </div>
                    `;
                });

                listElement.innerHTML = html;
            } catch (error) {
                console.error('Failed to load recent activity:', error);
                document.getElementById('recentActivityList').innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading activity</div>';
            }
        }

        // Wake cycle diagnostics
        async function refreshWakeCycle() {
            try {
                const response = await fetch('/api/wake-cycle-diagnostics');
                const data = await response.json();

                const timeline = document.getElementById('wakeCycleTimeline');

                if (!data.latestCycle) {
                    timeline.innerHTML = '<div style="color: #666; padding: 12px;">No wake cycle data available yet</div>';
                    return;
                }

                const cycle = data.latestCycle;
                const durationSec = Math.round(cycle.duration / 1000);
                const errorCount = cycle.errors.length;

                let html = `
                    <div class="diagnostic-summary">
                        <div class="diagnostic-stat">
                            <div class="diagnostic-stat-value">${durationSec}s</div>
                            <div class="diagnostic-stat-label">Duration</div>
                        </div>
                        <div class="diagnostic-stat">
                            <div class="diagnostic-stat-value">${cycle.events.length}</div>
                            <div class="diagnostic-stat-label">Events</div>
                        </div>
                        <div class="diagnostic-stat">
                            <div class="diagnostic-stat-value" style="color: ${errorCount > 0 ? '#ef4444' : '#10b981'}">${errorCount}</div>
                            <div class="diagnostic-stat-label">Errors</div>
                        </div>
                        <div class="diagnostic-stat">
                            <div class="diagnostic-stat-value">${cycle.incomplete ? 'Active' : 'Complete'}</div>
                            <div class="diagnostic-stat-label">Status</div>
                        </div>
                    </div>
                    <div class="timeline">
                `;

                // Show max 10 most relevant events
                const relevantEvents = cycle.events.slice(0, 10);
                relevantEvents.forEach((event, index) => {
                    const relativeTime = index === 0 ? '0s' : '+' + Math.round((event.time - cycle.startTime) / 1000) + 's';
                    const isError = event.level === 'ERROR' || event.message.toLowerCase().includes('error') || event.message.toLowerCase().includes('failed');
                    const errorClass = isError ? ' error' : '';

                    html += `
                        <div class="timeline-event${errorClass}">
                            <div class="timeline-time">${relativeTime}</div>
                            <div class="timeline-message">${escapeHtml(event.message)}</div>
                        </div>
                    `;
                });

                html += '</div>';
                timeline.innerHTML = html;
            } catch (error) {
                console.error('Failed to load wake cycle diagnostics:', error);
                document.getElementById('wakeCycleTimeline').innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading diagnostics</div>';
            }
        }

        // Load server console logs with structured display
        async function loadServerLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                const logOutput = document.getElementById('serverLogOutput');
                if (data.logs && data.logs.length > 0) {
                    // Parse and structure server logs
                    let html = '';
                    data.logs.forEach(logStr => {
                        // Parse: [2025-01-05 12:34:56] LOG: message or [2025-01-05 12:34:56] ERROR: message
                        const match = logStr.match(/\[([^\]]+)\] (LOG|ERROR): (.+)/);
                        if (match) {
                            const timeStr = match[1];
                            const level = match[2] === 'ERROR' ? 'ERROR' : 'INFO';
                            const message = match[3];
                            const timestamp = new Date(timeStr);
                            const time = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            const errorClass = level === 'ERROR' ? ' error' : '';

                            html += `
                                <div class="log-entry${errorClass}">
                                    <div class="log-timestamp">${time}</div>
                                    <div class="log-level log-level-${level}">${level}</div>
                                    <div class="log-source">server</div>
                                    <div class="log-message">${escapeHtml(message)}</div>
                                </div>
                            `;
                        } else {
                            // Fallback for unparsed logs
                            html += `
                                <div class="log-entry">
                                    <div class="log-message" style="flex: 1;">${escapeHtml(logStr)}</div>
                                </div>
                            `;
                        }
                    });
                    logOutput.innerHTML = html;
                    logOutput.scrollTop = logOutput.scrollHeight;
                } else {
                    logOutput.innerHTML = '<div style="color: #666; padding: 12px;">No server logs available</div>';
                }
            } catch (error) {
                console.error('Failed to load server logs:', error);
                document.getElementById('serverLogOutput').innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading server logs</div>';
            }
        }

        function clearServerLogs() {
            document.getElementById('serverLogOutput').innerHTML = '<div style="color: #666; padding: 12px;">Cleared (refresh to reload)</div>';
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'Auto: Off';
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadCombinedLogs();
                    refreshWakeCycle();
                    loadDeviceStatus();
                }, 3000);
                btn.textContent = 'Auto: On';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadSettings();
            loadDeviceStatus();
            loadSystemInfo();
            refreshRecentActivity();
            loadCombinedLogs();
            refreshWakeCycle();
            loadServerLogs();
            setInterval(loadDeviceStatus, 5000); // Update status every 5s
        });
    </script>
</body>
</html>
