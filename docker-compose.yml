services:
  glance-server:
    image: ${DOCKER_USERNAME:-chaerem}/glance-server:${IMAGE_VERSION:-latest}
    container_name: glance-server
    network_mode: host  # Use host networking - container sees real client IPs
    volumes:
      # Bind mount for data allows direct firmware updates without Docker rebuild
      - ./data:/app/data
      - glance-uploads:/app/uploads
    environment:
      - NODE_ENV=production
      - PORT=3000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - API_KEYS=${API_KEYS:-}
      - DOCKER_IMAGE_VERSION=${IMAGE_VERSION:-local}
      - BUILD_DATE=${BUILD_DATE:-unknown}
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  loki:
    image: grafana/loki:2.9.0
    container_name: glance-loki
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --output-document=- http://localhost:3100/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  promtail:
    image: grafana/promtail:2.9.0
    container_name: glance-promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml -config.expand-env=true
    environment:
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_USERNAME=${LOKI_USERNAME:-}
      - LOKI_API_KEY=${LOKI_API_KEY:-}
    # Remove depends_on if using Grafana Cloud (set LOKI_URL in .env)
    depends_on:
      loki:
        condition: service_started
        required: false
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    restart: unless-stopped

volumes:
  glance-uploads:
    driver: local
  loki-data:
    driver: local
